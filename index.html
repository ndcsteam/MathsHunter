<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>數字獵狩 - Microbit 數學遊戲</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            light: '#F59E0B', // 琥珀色
                            DEFAULT: '#D97706',
                            dark: '#B45309',
                        },
                        secondary: {
                            light: '#4F46E5', // 靛藍色
                            DEFAULT: '#4338CA',
                            dark: '#3730A3',
                        },
                        forest: {
                            light: '#10B981', // 翠綠色
                            DEFAULT: '#059669',
                            dark: '#047857',
                        }
                    },
                    fontFamily: {
                        game: ['Comic Sans MS', 'cursive', 'sans-serif']
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'wiggle': 'wiggle 1s ease-in-out infinite',
                        'float': 'float 3s ease-in-out infinite',
                    },
                    keyframes: {
                        wiggle: {
                            '0%, 100%': { transform: 'rotate(-3deg)' },
                            '50%': { transform: 'rotate(3deg)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&display=swap');

        body {
            font-family: 'Baloo 2', cursive, system-ui, sans-serif;
            background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%239C92AC" fill-opacity="0.08"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
        }

        .dark body {
            background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%239C92AC" fill-opacity="0.05"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
        }

        /* 答案選項動畫 */
        .option-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .option-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .option-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.2), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .option-card:hover::after {
            transform: translateX(100%);
        }

        /* 射擊動畫 */
        @keyframes hit {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        .hit-animation {
            animation: hit 0.5s ease-out;
        }

        /* 得分增加動畫 */
        @keyframes scoreUp {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); color: #10B981; }
            100% { transform: scale(1); }
        }

        .score-up {
            animation: scoreUp 0.7s ease;
        }

        /* 質感按鈕 */
        .game-button {
            position: relative;
            transition: all 0.2s ease;
            transform-style: preserve-3d;
        }

        .game-button::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.2);
            transform: translateZ(-1px);
            border-radius: inherit;
            transition: transform 0.2s ease;
        }

        .game-button:active {
            transform: translateY(4px);
        }

        .game-button:active::after {
            transform: translateZ(-1px) translateY(-4px);
        }

        /* 標題動畫 */
        .title-animated {
            display: inline-block;
            position: relative;
        }

        .title-animated::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 100%;
            height: 4px;
            background: currentColor;
            transform: scaleX(0);
            transform-origin: right;
            transition: transform 0.5s ease;
        }

        .title-animated:hover::after {
            transform: scaleX(1);
            transform-origin: left;
        }

        /* 文字題格式 */
        .word-problem {
            line-height: 1.6;
            position: relative;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }

        .word-problem::before {
            content: '"';
            font-size: 2.5rem;
            color: rgba(209, 213, 219, 0.5);
            position: absolute;
            left: -0.5rem;
            top: -1rem;
        }

        .word-problem::after {
            content: '"';
            font-size: 2.5rem;
            color: rgba(209, 213, 219, 0.5);
            position: absolute;
            right: -0.5rem;
            bottom: -1.5rem;
        }

        /* 慶祝動畫 */
        @keyframes celebrate {
            0% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0; transform: scale(2); }
        }

        .celebration-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            overflow: hidden;
            display: none;
        }

        .celebration-active {
            display: block;
        }

        .celebration-particle {
            position: absolute;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            animation: celebrate 1s ease-out forwards;
        }

        /* 打氣動畫 */
        @keyframes encourage-wave {
            0%, 100% { transform: translateY(0); }
            25% { transform: translateY(-15px); }
            75% { transform: translateY(10px); }
        }

        @keyframes encourage-fade {
            0% { opacity: 0; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0; transform: scale(1.5); }
        }

        .encouragement-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            z-index: 100;
            display: none;
        }

        .encouragement-active {
            display: flex;
        }

        .encouragement-message {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            color: #3730A3;
            background: rgba(255, 255, 255, 0.9);
            padding: 1rem 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: encourage-fade 1.5s ease-in-out forwards;
        }

        .encouragement-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: inline-block;
            animation: encourage-wave 0.7s ease-in-out infinite;
        }

        /* 計時器樣式 */
        .timer {
            font-size: 2.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .timer-warning {
            color: #F97316 !important; /* 橙色 */
        }

        .timer-danger {
            color: #EF4444 !important; /* 红色 */
            animation: pulse 0.5s infinite;
        }

        /* 遊戲結束動畫 */
        @keyframes slideIn {
            0% { transform: translateY(-100%); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .game-over-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.5s ease-out;
        }

        .game-over-panel {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            max-width: 90%;
            width: 500px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-orange-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen">
    <!-- 檢測深色/淺色模式 -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <!-- 慶祝動畫容器 -->
    <div id="celebration-container" class="celebration-container"></div>
    
    <!-- 打氣動畫容器 -->
    <div id="encouragement-container" class="encouragement-container">
        <div class="encouragement-message">
            <div class="encouragement-icon">💪</div>
            <div>加油！再試一次！</div>
        </div>
    </div>
    
    <!-- 遊戲結束容器 (預設隱藏) -->
    <div id="game-over-container" class="game-over-container hidden">
        <div class="game-over-panel dark:bg-gray-800">
            <h2 class="text-3xl font-bold mb-4 text-primary-dark dark:text-primary-light">遊戲結束!</h2>
            <p class="text-xl mb-6">時間到！</p>
            
            <div class="flex flex-col items-center mb-6">
                <div class="text-2xl mb-2">你的得分</div>
                <div id="final-score" class="text-5xl font-bold text-primary-dark dark:text-primary-light mb-4">0</div>
                <div id="score-message" class="text-lg italic">再接再厲！</div>
            </div>
            
            <button id="restart-button" class="game-button bg-gradient-to-r from-primary-light to-primary px-6 py-3 text-white rounded-full shadow-md hover:shadow-lg flex items-center mx-auto">
                <i class="fas fa-redo-alt mr-2"></i>
                <span>再玩一次</span>
            </button>
        </div>
    </div>

    <div class="container mx-auto px-4 py-6">
        <header class="mb-8">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="text-center">
                    <h1 class="text-4xl font-bold text-primary-dark dark:text-primary-light flex items-center">
                        <span class="title-animated mr-2">數字獵狩</span>
                        <i class="fas fa-crosshairs text-secondary-light animate-pulse ml-2"></i>
                    </h1>
                    <p class="mt-2 text-gray-600 dark:text-gray-400 italic">
                        瞄準數學問題，擊中正確答案！
                    </p>
                </div>
                <button id="connect-button" class="game-button bg-gradient-to-r from-primary-light to-primary px-6 py-3 text-white rounded-full shadow-lg hover:shadow-xl flex items-center space-x-2 transform hover:scale-105 transition-all">
                    <i class="fas fa-plug mr-2"></i>
                    <span>連接獵狩裝置</span>
                </button>
            </div>
        </header>

        <div class="max-w-4xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-xl p-6 border-2 border-primary-light dark:border-primary-dark">
            <!-- 遊戲區域 -->
            <div id="game-section" class="opacity-50 pointer-events-none">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-gamepad text-secondary-light text-2xl mr-3"></i>
                        <h2 class="text-2xl font-bold text-secondary-dark dark:text-secondary-light">射擊挑戰</h2>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="bg-gray-100 dark:bg-gray-700 rounded-full px-5 py-2 flex items-center">
                            <i class="fas fa-star text-yellow-500 mr-2"></i>
                            <span class="text-gray-600 dark:text-gray-300 font-medium">獵人得分：</span>
                            <span id="score" class="font-bold text-primary text-2xl ml-2">0</span>
                        </div>
                        <button id="start-button" class="game-button bg-gradient-to-r from-forest-light to-forest px-6 py-3 text-white rounded-full shadow-md hover:shadow-lg flex items-center">
                            <i class="fas fa-play mr-2"></i>
                            <span>開始挑戰</span>
                        </button>
                    </div>
                </div>

                <!-- 計時器 -->
                <div id="timer-container" class="w-full flex justify-center mb-4 hidden">
                    <div class="flex items-center bg-gray-100 dark:bg-gray-700 px-6 py-2 rounded-full">
                        <i class="fas fa-hourglass-half text-yellow-500 text-2xl mr-3"></i>
                        <div id="timer" class="text-3xl font-bold text-gray-700 dark:text-gray-300">60</div>
                    </div>
                </div>

                <!-- 問題展示區 - 獵場 -->
                <div id="question-container" class="p-8 bg-gradient-to-br from-amber-50 to-orange-100 dark:from-gray-900 dark:to-gray-800 rounded-xl mb-6 shadow-inner border border-amber-200 dark:border-gray-700">
                    <div id="question-text" class="text-3xl font-bold text-center mb-8 py-3 px-6 bg-white dark:bg-gray-800 rounded-xl shadow-md inline-block mx-auto animate-float">
                        準備好後點擊「開始挑戰」按鈕
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="option-card bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md hover:bg-amber-50 dark:hover:bg-gray-700 border-2 border-transparent hover:border-primary-light dark:hover:border-primary cursor-pointer">
                            <div class="flex items-center">
                                <div class="h-12 w-12 flex items-center justify-center bg-primary-light text-white rounded-full mr-4 shadow-md">
                                    <span class="text-xl font-bold">A</span>
                                </div>
                                <div id="answer-a" class="text-2xl font-medium">-</div>
                            </div>
                        </div>
                        <div class="option-card bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md hover:bg-amber-50 dark:hover:bg-gray-700 border-2 border-transparent hover:border-primary-light dark:hover:border-primary cursor-pointer">
                            <div class="flex items-center">
                                <div class="h-12 w-12 flex items-center justify-center bg-primary-light text-white rounded-full mr-4 shadow-md">
                                    <span class="text-xl font-bold">B</span>
                                </div>
                                <div id="answer-b" class="text-2xl font-medium">-</div>
                            </div>
                        </div>
                        <div class="option-card bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md hover:bg-amber-50 dark:hover:bg-gray-700 border-2 border-transparent hover:border-primary-light dark:hover:border-primary cursor-pointer">
                            <div class="flex items-center">
                                <div class="h-12 w-12 flex items-center justify-center bg-primary-light text-white rounded-full mr-4 shadow-md">
                                    <span class="text-xl font-bold">C</span>
                                </div>
                                <div id="answer-c" class="text-2xl font-medium">-</div>
                            </div>
                        </div>
                        <div class="option-card bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md hover:bg-amber-50 dark:hover:bg-gray-700 border-2 border-transparent hover:border-primary-light dark:hover:border-primary cursor-pointer">
                            <div class="flex items-center">
                                <div class="h-12 w-12 flex items-center justify-center bg-primary-light text-white rounded-full mr-4 shadow-md">
                                    <span class="text-xl font-bold">D</span>
                                </div>
                                <div id="answer-d" class="text-2xl font-medium">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="feedback" class="hidden p-6 rounded-xl mb-6 text-center font-bold text-xl flex items-center justify-center">
                    <span id="feedback-text"></span>
                </div>
            </div>
        </div>

        <footer class="mt-6 text-center text-gray-500 dark:text-gray-400 text-sm">
            <p>數字獵狩 &copy; 2023 - 小五小六數學練習遊戲</p>
        </footer>
    </div>

    <!-- 音效元素 -->
    <audio id="countdown-audio" src="./audio/CountDown.mp3" preload="auto"></audio>

    <script>
        // 遊戲變數
        let port;
        let reader;
        let inputDone;
        let score = 0;
        let currentQuestion = null;
        let isGameRunning = false;
        let gameEnabled = false;
        let timerInterval = null;
        let timeLeft = 60; // 遊戲時間60秒
        let countdownAudio = null;

        // DOM元素
        const connectButton = document.getElementById('connect-button');
        const startButton = document.getElementById('start-button');
        const scoreDisplay = document.getElementById('score');
        const questionText = document.getElementById('question-text');
        const answerA = document.getElementById('answer-a');
        const answerB = document.getElementById('answer-b');
        const answerC = document.getElementById('answer-c');
        const answerD = document.getElementById('answer-d');
        const gameSection = document.getElementById('game-section');
        const feedback = document.getElementById('feedback');
        const feedbackText = document.getElementById('feedback-text');
        const celebrationContainer = document.getElementById('celebration-container');
        const encouragementContainer = document.getElementById('encouragement-container');
        const timerContainer = document.getElementById('timer-container');
        const timerDisplay = document.getElementById('timer');
        const gameOverContainer = document.getElementById('game-over-container');
        const finalScoreDisplay = document.getElementById('final-score');
        const scoreMessageDisplay = document.getElementById('score-message');
        const restartButton = document.getElementById('restart-button');
        const countdownAudioElement = document.getElementById('countdown-audio');

        // 連接到Microbit
        connectButton.addEventListener('click', async () => {
            try {
                // 檢查瀏覽器是否支援Web Serial API
                if (!('serial' in navigator)) {
                    showNotification('您的瀏覽器不支援Web Serial API。請使用Chrome或Edge瀏覽器。', true);
                    return;
                }

                // 請求訪問Serial端口
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                
                // 設置讀取器
                reader = port.readable.getReader();
                
                // 更新連接狀態
                showNotification('已連接 - 獵狩裝置準備就緒！', false);
                connectButton.innerHTML = '<i class="fas fa-check-circle mr-2"></i><span>已連接</span>';
                connectButton.disabled = true;
                connectButton.classList.remove('from-primary-light', 'to-primary');
                connectButton.classList.add('from-green-500', 'to-green-600');
                
                // 啟用遊戲區域
                gameSection.classList.remove('opacity-50', 'pointer-events-none');
                gameEnabled = true;

                // 開始讀取數據
                readData();
            } catch (error) {
                console.error('連接錯誤:', error);
                showNotification(`連接錯誤: ${error.message}`, true);
            }
        });

        // 計時器功能
        function startTimer() {
            // 顯示計時器
            timerContainer.classList.remove('hidden');
            timeLeft = 60; // 重置時間
            updateTimerDisplay();
            
            // 啟動計時器
            clearInterval(timerInterval); // 清除舊計時器
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                // 當時間低於10秒時，添加警告樣式
                if (timeLeft <= 10) {
                    timerDisplay.classList.add('timer-danger');
                } else if (timeLeft <= 20) {
                    timerDisplay.classList.add('timer-warning');
                    timerDisplay.classList.remove('timer-danger');
                } else {
                    timerDisplay.classList.remove('timer-warning', 'timer-danger');
                }
                
                // 時間結束時
                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        // 更新計時器顯示
        function updateTimerDisplay() {
            timerDisplay.textContent = timeLeft;
        }

        // 結束遊戲
        function endGame() {
            // 停止計時器
            clearInterval(timerInterval);
            
            // 停止音樂
            if (countdownAudio) {
                countdownAudio.pause();
                countdownAudio.currentTime = 0;
            }
            
            // 更新最終分數
            finalScoreDisplay.textContent = score;
            
            // 設置最終分數訊息
            if (score >= 20) {
                scoreMessageDisplay.textContent = '太厲害了！你是數學天才！';
            } else if (score >= 15) {
                scoreMessageDisplay.textContent = '好棒！你的數學能力很強！';
            } else if (score >= 10) {
                scoreMessageDisplay.textContent = '做得好！繼續努力！';
            } else if (score >= 5) {
                scoreMessageDisplay.textContent = '加油！你可以做得更好！';
            } else {
                scoreMessageDisplay.textContent = '別灰心，繼續練習，你會進步的！';
            }
            
            // 顯示遊戲結束畫面
            gameOverContainer.classList.remove('hidden');
            
            // 停止遊戲
            isGameRunning = false;
        }

        // 重新開始遊戲
        restartButton.addEventListener('click', () => {
            // 隱藏遊戲結束畫面
            gameOverContainer.classList.add('hidden');
            
            // 重置分數
            score = 0;
            scoreDisplay.textContent = '0';
            
            // 啟動新遊戲
            startGame();
        });

        // 顯示通知（僅在控制台）
        function showNotification(message, isError) {
            const statusType = isError ? 'error' : 'info';
            const statusPrefix = isError ? '錯誤: ' : '狀態: ';
            
            if (isError) {
                console.error(statusPrefix + message);
            } else {
                console.log(statusPrefix + message);
            }
        }

        // 讀取Microbit數據
        async function readData() {
            while (true) {
                try {
                    const { value, done } = await reader.read();
                    if (done) {
                        // 流已關閉
                        break;
                    }
                    // 將接收到的數據解碼為文本
                    const valueString = new TextDecoder().decode(value).trim();
                    console.log("接收到的數據:", valueString);
                    // 處理接收到的選項
                    if (valueString === 'A' || valueString === 'B' || valueString === 'C' || valueString === 'D') {
                        processAnswer(valueString);
                    }
                } catch (error) {
                    console.error('讀取錯誤:', error);
                    break;
                }
            }
        }

        // 開始遊戲
        function startGame() {
            if (!gameEnabled && !confirm('你尚未連接獵狩裝置。要繼續嗎？')) {
                return;
            }
            
            isGameRunning = true;
            score = 0;
            scoreDisplay.textContent = '0';
            startButton.innerHTML = '<i class="fas fa-forward mr-2"></i><span>下一題</span>';
            
            // 播放音樂
            try {
                // 嘗試播放音樂
                countdownAudio = new Audio('./audio/CountDown.mp3');
                countdownAudio.play().catch(error => {
                    console.error('無法播放音頻:', error);
                    // 嘗試使用HTML audio元素
                    countdownAudioElement.play().catch(err => {
                        console.error('兩種方法都無法播放音頻:', err);
                    });
                });
            } catch (error) {
                console.error('播放音頻時發生錯誤:', error);
            }
            
            // 啟動計時器
            startTimer();
            
            // 生成第一個問題
            generateQuestion();
        }

        // 點擊開始按鈕
        startButton.addEventListener('click', () => {
            if (isGameRunning) {
                // 如果遊戲已經在運行，則生成新問題
                generateQuestion();
            } else {
                // 開始新遊戲
                startGame();
            }
        });

        // 慶祝動畫
        function playCelebrationAnimation() {
            celebrationContainer.innerHTML = ''; // 清空之前的粒子
            celebrationContainer.classList.add('celebration-active');
            
            // 創建彩色粒子
            const colors = [
                '#10B981', // 綠色
                '#3B82F6', // 藍色
                '#F59E0B', // 琥珀色
                '#EC4899', // 粉紅色
                '#8B5CF6', // 紫色
                '#F43F5E', // 紅色
                '#FBBF24'  // 黃色
            ];
            
            const particleCount = 60; // 粒子數量
            
            for (let i = 0; i < particleCount; i++) {
                // 創建粒子元素
                const particle = document.createElement('div');
                particle.classList.add('celebration-particle');
                
                // 隨機位置
                const x = Math.random() * window.innerWidth;
                const y = Math.random() * window.innerHeight;
                
                // 隨機大小
                const size = Math.random() * 10 + 8;
                
                // 隨機顏色
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                // 隨機延遲
                const delay = Math.random() * 1.5;
                
                // 設置樣式
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.backgroundColor = color;
                particle.style.animationDelay = `${delay}s`;
                
                // 添加到容器
                celebrationContainer.appendChild(particle);
            }
            
            // 一段時間後移除動畫
            setTimeout(() => {
                celebrationContainer.classList.remove('celebration-active');
            }, 2500);
        }

        // 打氣動畫
        function playEncouragementAnimation() {
            encouragementContainer.classList.add('encouragement-active');
            
            // 隨機鼓勵短語
            const messages = [
                '加油！再試一次！',
                '別放棄！你能做到！',
                '下一題會更好！',
                '繼續努力！'
            ];
            
            // 隨機表情符號
            const emojis = ['💪', '🔥', '✨', '📚', '🧠'];
            
            // 隨機選擇一條訊息和表情符號
            const message = messages[Math.floor(Math.random() * messages.length)];
            const emoji = emojis[Math.floor(Math.random() * emojis.length)];
            
            // 更新內容
            const messageElement = encouragementContainer.querySelector('.encouragement-message div:last-child');
            const emojiElement = encouragementContainer.querySelector('.encouragement-icon');
            
            if (messageElement && emojiElement) {
                messageElement.textContent = message;
                emojiElement.textContent = emoji;
            }
            
            // 一段時間後移除動畫
            setTimeout(() => {
                encouragementContainer.classList.remove('encouragement-active');
            }, 1500);
        }

        // 題目類別與生成
        const questionTypes = [
            // 0. 基本四則運算(較簡單)
            {
                name: "基本運算",
                icon: "calculator",
                generator: function() {
                    const operations = ['+', '-', '×', '÷'];
                    const op = operations[Math.floor(Math.random() * 4)];
                    
                    let num1, num2, answer, question;
                    
                    switch(op) {
                        case '+': // 加法
                            num1 = Math.floor(Math.random() * 50) + 1;
                            num2 = Math.floor(Math.random() * 50) + 1;
                            answer = num1 + num2;
                            question = `${num1} + ${num2} = ?`;
                            break;
                            
                        case '-': // 減法(確保結果為正數)
                            num1 = Math.floor(Math.random() * 50) + 51; // 51-100
                            num2 = Math.floor(Math.random() * 50) + 1;  // 1-50
                            answer = num1 - num2;
                            question = `${num1} - ${num2} = ?`;
                            break;
                            
                        case '×': // 乘法
                            num1 = Math.floor(Math.random() * 10) + 1;
                            num2 = Math.floor(Math.random() * 10) + 1;
                            answer = num1 * num2;
                            question = `${num1} × ${num2} = ?`;
                            break;
                            
                        case '÷': // 除法(確保能整除)
                            num2 = Math.floor(Math.random() * 10) + 1; // 除數 1-10
                            answer = Math.floor(Math.random() * 10) + 1; // 商 1-10
                            num1 = num2 * answer; // 被除數
                            question = `${num1} ÷ ${num2} = ?`;
                            break;
                    }
                    
                    return { question, answer };
                }
            },
            
            // 1. 高階計算(較複雜)
            {
                name: "進階運算",
                icon: "square-root-variable",
                generator: function() {
                    const subTypes = ['混合運算', '分數', '小數'];
                    const subType = subTypes[Math.floor(Math.random() * subTypes.length)];
                    
                    let question, answer;
                    
                    switch(subType) {
                        case '混合運算':
                            // 生成兩步運算，如 3x4+5 或 20÷4-2
                            const ops = ['+', '-'];
                            const op = ops[Math.floor(Math.random() * ops.length)];
                            
                            // 先算乘/除部分
                            let num1, num2, num3, midResult;
                            
                            if (Math.random() < 0.5) { // 乘法優先
                                num1 = Math.floor(Math.random() * 10) + 1; // 1-10
                                num2 = Math.floor(Math.random() * 10) + 1; // 1-10
                                midResult = num1 * num2;
                                
                                if (op === '+') {
                                    num3 = Math.floor(Math.random() * 20) + 1; // 1-20
                                    answer = midResult + num3;
                                    question = `${num1} × ${num2} + ${num3} = ?`;
                                } else {
                                    num3 = Math.floor(Math.random() * midResult) + 1; // 確保結果為正
                                    answer = midResult - num3;
                                    question = `${num1} × ${num2} - ${num3} = ?`;
                                }
                            } else { // 除法優先
                                num2 = Math.floor(Math.random() * 9) + 2; // 除數 2-10
                                answer = Math.floor(Math.random() * 9) + 1; // 商 1-9
                                
                                if (op === '+') {
                                    num3 = Math.floor(Math.random() * 20) + 1; // 1-20
                                    midResult = answer - num3; // 先算出中間結果，確保最終答案為整數
                                    num1 = midResult * num2; // 被除數
                                    answer = midResult + num3;
                                    question = `${num1} ÷ ${num2} + ${num3} = ?`;
                                } else {
                                    num3 = Math.floor(Math.random() * 10) + 1; // 1-10
                                    midResult = answer + num3; // 先算出中間結果，確保最終答案為整數
                                    num1 = midResult * num2; // 被除數
                                    answer = midResult - num3;
                                    question = `${num1} ÷ ${num2} - ${num3} = ?`;
                                }
                            }
                            break;
                            
                        case '分數':
                            // 簡單分數加減法，使用相同分母
                            const denominator = Math.floor(Math.random() * 8) + 2; // 分母 2-9
                            const numer1 = Math.floor(Math.random() * (denominator - 1)) + 1; // 分子1
                            let numer2;
                            
                            if (Math.random() < 0.5) { // 加法
                                numer2 = Math.floor(Math.random() * (denominator - 1)) + 1; // 分子2
                                answer = numer1 + numer2;
                                // 檢查是否需要化簡
                                if (answer > denominator) {
                                    const whole = Math.floor(answer / denominator);
                                    const remainder = answer % denominator;
                                    if (remainder === 0) {
                                        answer = whole;
                                        question = `\\(\\frac{${numer1}}{${denominator}} + \\frac{${numer2}}{${denominator}} = ?\\)`;
                                    } else {
                                        answer = `${whole}又${remainder}/${denominator}`;
                                        question = `\\(\\frac{${numer1}}{${denominator}} + \\frac{${numer2}}{${denominator}} = ?\\)`;
                                    }
                                } else {
                                    answer = `${answer}/${denominator}`;
                                    question = `\\(\\frac{${numer1}}{${denominator}} + \\frac{${numer2}}{${denominator}} = ?\\)`;
                                }
                            } else { // 減法，確保結果為正
                                numer2 = Math.floor(Math.random() * numer1) + 1; // 確保 numer1 > numer2
                                answer = numer1 - numer2;
                                answer = `${answer}/${denominator}`;
                                question = `\\(\\frac{${numer1}}{${denominator}} - \\frac{${numer2}}{${denominator}} = ?\\)`;
                            }
                            
                            // 將數學符號轉換為顯示格式
                            question = `<span class="text-2xl">
                                          ${numer1}/${denominator} ${Math.random() < 0.5 ? '+' : '-'} ${numer2}/${denominator} = ?
                                        </span>`;
                            break;
                            
                        case '小數':
                            // 一位小數加減法
                            const int1 = Math.floor(Math.random() * 20) + 1; // 整數部分 1-20
                            const dec1 = Math.floor(Math.random() * 10); // 小數部分 0-9
                            const int2 = Math.floor(Math.random() * 20) + 1; // 整數部分 1-20
                            const dec2 = Math.floor(Math.random() * 10); // 小數部分 0-9
                            
                            const decNum1 = int1 + dec1/10;
                            const decNum2 = int2 + dec2/10;
                            
                            if (Math.random() < 0.5) { // 加法
                                answer = (decNum1 + decNum2).toFixed(1);
                                answer = parseFloat(answer); // 移除不必要的零
                                question = `${decNum1.toFixed(1)} + ${decNum2.toFixed(1)} = ?`;
                            } else { // 減法，確保結果為正
                                if (decNum1 >= decNum2) {
                                    answer = (decNum1 - decNum2).toFixed(1);
                                    answer = parseFloat(answer); // 移除不必要的零
                                    question = `${decNum1.toFixed(1)} - ${decNum2.toFixed(1)} = ?`;
                                } else {
                                    answer = (decNum2 - decNum1).toFixed(1);
                                    answer = parseFloat(answer); // 移除不必要的零
                                    question = `${decNum2.toFixed(1)} - ${decNum1.toFixed(1)} = ?`;
                                }
                            }
                            break;
                    }
                    
                    return { question, answer };
                }
            },
            
            // 2. 簡單應用題
            {
                name: "日常應用",
                icon: "person-walking",
                generator: function() {
                    const topics = [
                        '購物計算', 
                        '時間問題', 
                        '長度測量', 
                        '重量計算',
                        '速度問題'
                    ];
                    const topic = topics[Math.floor(Math.random() * topics.length)];
                    
                    let question, answer, story;
                    
                    switch(topic) {
                        case '購物計算':
                            // 生成購物情境題
                            const items = ['鉛筆', '橡皮擦', '記事本', '鋼筆', '水彩筆', '書包', '尺', '文具盒'];
                            const item1 = items[Math.floor(Math.random() * items.length)];
                            let item2;
                            do {
                                item2 = items[Math.floor(Math.random() * items.length)];
                            } while (item2 === item1);
                            
                            const price1 = Math.floor(Math.random() * 20) + 5; // 5-24元
                            const price2 = Math.floor(Math.random() * 30) + 10; // 10-39元
                            const quantity1 = Math.floor(Math.random() * 5) + 1; // 1-5個
                            const quantity2 = Math.floor(Math.random() * 5) + 1; // 1-5個
                            
                            const total = price1 * quantity1 + price2 * quantity2;
                            const money = Math.ceil(total / 10) * 10 + Math.floor(Math.random() * 5) * 10; // 確保足夠找零
                            const change = money - total;
                            
                            const questionTypes = ['total', 'change'];
                            const questionType = questionTypes[Math.floor(Math.random() * questionTypes.length)];
                            
                            story = `小明去文具店買了${quantity1}支${item1}，每支${price1}元，和${quantity2}個${item2}，每個${price2}元。`;
                            
                            if (questionType === 'total') {
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>小明一共需要付多少錢？</div>`;
                                answer = total;
                            } else {
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}小明付了${money}元，應該找回多少錢？</div>`;
                                answer = change;
                            }
                            break;
                            
                        case '時間問題':
                            // 生成時間計算題
                            const hour1 = Math.floor(Math.random() * 12) + 1; // 1-12點
                            const minute1 = Math.floor(Math.random() * 12) * 5; // 0, 5, 10, ..., 55分
                            
                            // 產生一個時間間隔，以分鐘計
                            const interval = (Math.floor(Math.random() * 12) + 1) * 15; // 15, 30, 45, ..., 180分鐘
                            
                            // 計算結束時間
                            let totalMinutes = hour1 * 60 + minute1 + interval;
                            let hour2 = Math.floor(totalMinutes / 60);
                            if (hour2 > 12) hour2 -= 12; // 使用12小時制
                            if (hour2 === 0) hour2 = 12;
                            const minute2 = totalMinutes % 60;
                            
                            const activities = ['看電影', '踢足球', '上數學課', '畫畫', '彈鋼琴', '玩電腦遊戲', '讀書'];
                            const activity = activities[Math.floor(Math.random() * activities.length)];
                            
                            const minute1Str = minute1 < 10 ? `0${minute1}` : minute1;
                            const minute2Str = minute2 < 10 ? `0${minute2}` : minute2;
                            
                            story = `小華在下午${hour1}:${minute1Str}開始${activity}，一直到${hour2}:${minute2Str}結束。`;
                            question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>小華${activity}了多少分鐘？</div>`;
                            answer = interval;
                            break;
                            
                        case '長度測量':
                            // 生成長度、距離計算題
                            const lengths = [
                                { unit: '公分', value: Math.floor(Math.random() * 50) + 20 }, // 20-69公分
                                { unit: '公分', value: Math.floor(Math.random() * 30) + 10 }  // 10-39公分
                            ];
                            
                            const objectTypes = ['繩子', '布條', '木板', '紙條'];
                            const objectType = objectTypes[Math.floor(Math.random() * objectTypes.length)];
                            
                            if (Math.random() < 0.5) { // 加法
                                story = `小芳有一條${lengths[0].value}${lengths[0].unit}長的${objectType}，小強有一條${lengths[1].value}${lengths[1].unit}長的${objectType}。`;
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>如果把兩條${objectType}連接起來，總長度是多少${lengths[0].unit}？</div>`;
                                answer = lengths[0].value + lengths[1].value;
                            } else { // 減法
                                const total = lengths[0].value + lengths[1].value;
                                story = `小芳有一條${total}${lengths[0].unit}長的${objectType}，她剪下了${lengths[1].value}${lengths[1].unit}。`;
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>剩下的${objectType}長度是多少${lengths[0].unit}？</div>`;
                                answer = lengths[0].value;
                            }
                            break;
                            
                        case '重量計算':
                            // 生成重量計算題
                            const weights = [
                                { unit: '公斤', value: Math.floor(Math.random() * 10) + 1 }, // 1-10公斤
                                { unit: '公斤', value: Math.floor(Math.random() * 5) + 1 }   // 1-5公斤
                            ];
                            
                            const fruitTypes = ['蘋果', '橘子', '香蕉', '西瓜', '鳳梨'];
                            const fruitType = fruitTypes[Math.floor(Math.random() * fruitTypes.length)];
                            
                            if (Math.random() < 0.5) { // 乘法
                                const quantity = Math.floor(Math.random() * 5) + 2; // 2-6個
                                story = `一個${fruitType}的重量是${weights[0].value}${weights[0].unit}。`;
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>${quantity}個${fruitType}的總重量是多少${weights[0].unit}？</div>`;
                                answer = weights[0].value * quantity;
                            } else { // 加法或減法
                                if (Math.random() < 0.5) { // 加法
                                    const fruit2Types = fruitTypes.filter(f => f !== fruitType);
                                    const fruit2Type = fruit2Types[Math.floor(Math.random() * fruit2Types.length)];
                                    story = `小明買了${weights[0].value}${weights[0].unit}的${fruitType}和${weights[1].value}${weights[1].unit}的${fruit2Type}。`;
                                    question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>他一共買了多少${weights[0].unit}的水果？</div>`;
                                    answer = weights[0].value + weights[1].value;
                                } else { // 減法
                                    const total = weights[0].value + weights[1].value;
                                    story = `小明買了${total}${weights[0].unit}的${fruitType}，吃掉了${weights[1].value}${weights[1].unit}。`;
                                    question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>還剩下多少${weights[0].unit}的${fruitType}？</div>`;
                                    answer = weights[0].value;
                                }
                            }
                            break;
                            
                        case '速度問題':
                            // 生成簡單速度計算題
                            const speeds = [
                                { unit: '公里/小時', value: Math.floor(Math.random() * 30) + 30 }, // 30-59公里/小時
                                { unit: '小時', value: Math.floor(Math.random() * 3) + 1 }        // 1-3小時
                            ];
                            
                            const vehicles = ['腳踏車', '汽車', '公車', '火車'];
                            const vehicle = vehicles[Math.floor(Math.random() * vehicles.length)];
                            
                            // 速度×時間=距離
                            const distance = speeds[0].value * speeds[1].value;
                            
                            if (Math.random() < 0.5) { // 求距離
                                story = `小明乘坐${vehicle}，以每小時${speeds[0].value}公里的速度行駛了${speeds[1].value}小時。`;
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>小明行駛了多少公里？</div>`;
                                answer = distance;
                            } else { // 求時間
                                story = `小明乘坐${vehicle}，以每小時${speeds[0].value}公里的速度行駛，一共行駛了${distance}公里。`;
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>小明行駛了多少小時？</div>`;
                                answer = speeds[1].value;
                            }
                            break;
                    }
                    
                    return { question, answer };
                }
            },
            
            // 3. 進階應用題
            {
                name: "進階應用",
                icon: "brain",
                generator: function() {
                    const topics = [
                        '百分比', 
                        '比例問題', 
                        '面積計算', 
                        '邏輯推理'
                    ];
                    const topic = topics[Math.floor(Math.random() * topics.length)];
                    
                    let question, answer, story;
                    
                    switch(topic) {
                        case '百分比':
                            // 生成百分比計算題
                            const percentages = [10, 20, 25, 30, 40, 50, 60, 75, 80, 90];
                            const percentage = percentages[Math.floor(Math.random() * percentages.length)];
                            const total = (Math.floor(Math.random() * 20) + 10) * 10; // 100, 110, 120, ... 290
                            const part = total * percentage / 100;
                            
                            const scenarios = [
                                { item: '學生', context: `班上有${total}名學生，其中${percentage}%是男生。` },
                                { item: '蘋果', context: `籃子裡有${total}個蘋果，其中${percentage}%是紅蘋果。` },
                                { item: '元', context: `小明有${total}元，他花了${percentage}%買文具。` },
                                { item: '題目', context: `小華做了${total}題數學題，其中${percentage}%做對了。` }
                            ];
                            
                            const scenario = scenarios[Math.floor(Math.random() * scenarios.length)];
                            
                            if (Math.random() < 0.5) { // 求部分
                                story = scenario.context;
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>那麼有多少${scenario.item}${scenario.item === '元' ? '用於買文具' : ''}？</div>`;
                                answer = part;
                            } else { // 給定部分求百分比
                                story = `班上有${total}名學生，其中${part}名是男生。`;
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>男生占全班學生的百分之幾？</div>`;
                                answer = percentage + '%';
                            }
                            break;
                            
                        case '比例問題':
                            // 生成比例計算題
                            const ratios = [
                                [1, 2], [1, 3], [1, 4], [2, 3], [2, 5], [3, 4], [3, 5], [3, 7], [4, 5]
                            ];
                            const ratio = ratios[Math.floor(Math.random() * ratios.length)];
                            
                            const multiplier = Math.floor(Math.random() * 5) + 2; // 2-6
                            const value1 = ratio[0] * multiplier;
                            const value2 = ratio[1] * multiplier;
                            const total_value = value1 + value2;
                            
                            if (Math.random() < 0.5) { // 求值
                                story = `小明和小華分糖果，小明分到的糖果與小華分到的糖果比是${ratio[0]}:${ratio[1]}。他們一共分到${total_value}個糖果。`;
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>小明分到了多少個糖果？</div>`;
                                answer = value1;
                            } else { // 給定值求比例
                                story = `小明有${value1}張貼紙，小華有${value2}張貼紙。`;
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>小明的貼紙數與小華的貼紙數之比是多少？(用最簡分數表示)</div>`;
                                answer = `${ratio[0]}:${ratio[1]}`;
                            }
                            break;
                            
                        case '面積計算':
                            // 生成矩形或正方形面積計算題
                            if (Math.random() < 0.7) { // 矩形
                                const length = Math.floor(Math.random() * 10) + 5; // 5-14
                                const width = Math.floor(Math.random() * 5) + 3;  // 3-7
                                const area = length * width;
                                
                                if (Math.random() < 0.5) { // 求面積
                                    story = `一個長方形的長是${length}公尺，寬是${width}公尺。`;
                                    question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>這個長方形的面積是多少平方公尺？</div>`;
                                    answer = area;
                                } else { // 給定面積和一邊求另一邊
                                    if (Math.random() < 0.5) {
                                        story = `一個長方形的面積是${area}平方公尺，長是${length}公尺。`;
                                        question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>這個長方形的寬是多少公尺？</div>`;
                                        answer = width;
                                    } else {
                                        story = `一個長方形的面積是${area}平方公尺，寬是${width}公尺。`;
                                        question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>這個長方形的長是多少公尺？</div>`;
                                        answer = length;
                                    }
                                }
                            } else { // 正方形
                                const side = Math.floor(Math.random() * 15) + 5; // 5-19
                                const area = side * side;
                                
                                if (Math.random() < 0.5) { // 求面積
                                    story = `一個正方形的邊長是${side}厘米。`;
                                    question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>這個正方形的面積是多少平方厘米？</div>`;
                                    answer = area;
                                } else { // 給定面積求邊長
                                    story = `一個正方形的面積是${area}平方厘米。`;
                                    question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>這個正方形的邊長是多少厘米？</div>`;
                                    answer = side;
                                }
                            }
                            break;
                            
                        case '邏輯推理':
                            // 生成簡單邏輯推理題
                            const logicTypes = ['數列', '規律找數'];
                            const logicType = logicTypes[Math.floor(Math.random() * logicTypes.length)];
                            
                            if (logicType === '數列') {
                                // 生成等差數列
                                const start = Math.floor(Math.random() * 10) + 1; // 1-10
                                const diff = Math.floor(Math.random() * 5) + 1;  // 1-5
                                
                                const sequence = [];
                                for (let i = 0; i < 5; i++) {
                                    sequence.push(start + diff * i);
                                }
                                
                                const nextNum = start + diff * 5;
                                
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">找出數列的規律，並填入下一個數：<br><span class="text-2xl">${sequence.join(', ')}，?</span></div>`;
                                answer = nextNum;
                            } else { // 規律找數
                                // 生成乘法或平方規律
                                const rules = [
                                    // 平方數
                                    () => {
                                        const sequence = [1, 4, 9, 16, 25, 36, 49, 64];
                                        const selected = Math.floor(Math.random() * (sequence.length - 4));
                                        return { sequence: sequence.slice(selected, selected + 4), next: sequence[selected + 4] };
                                    },
                                    // 乘以固定數
                                    () => {
                                        const multiplier = Math.floor(Math.random() * 3) + 2; // 2, 3, 4
                                        const start = Math.floor(Math.random() * 4) + 1; // 1-4
                                        
                                        const sequence = [];
                                        let current = start;
                                        for (let i = 0; i < 4; i++) {
                                            sequence.push(current);
                                            current *= multiplier;
                                        }
                                        
                                        return { sequence, next: current };
                                    },
                                    // 斐波那契數列的一部分
                                    () => {
                                        const fibonacci = [1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89];
                                        const selected = Math.floor(Math.random() * (fibonacci.length - 5));
                                        return { sequence: fibonacci.slice(selected, selected + 4), next: fibonacci[selected + 4] };
                                    }
                                ];
                                
                                const rule = rules[Math.floor(Math.random() * rules.length)]();
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">找出數列的規律，並填入下一個數：<br><span class="text-2xl">${rule.sequence.join(', ')}，?</span></div>`;
                                answer = rule.next;
                            }
                            break;
                    }
                    
                    return { question, answer };
                }
            }
        ];

        // 生成題目
        function generateQuestion() {
            // 隱藏之前的反饋
            feedback.className = 'hidden';
            
            // 如果遊戲已結束，不生成新問題
            if (!isGameRunning) return;
            
            // 隨機選擇題型
            const questionTypeIndex = Math.floor(Math.random() * questionTypes.length);
            const questionType = questionTypes[questionTypeIndex];
            
            // 生成問題和答案
            const { question, answer } = questionType.generator();
            
            // 生成選項
            let options = [];
            const correctAnswer = answer;
            
            // 特殊情況處理
            let answerIsText = false;
            let numAnswer;
            
            if (typeof correctAnswer === 'string') {
                // 檢查是否為百分比形式
                if (correctAnswer.includes('%')) {
                    const numValue = parseInt(correctAnswer);
                    numAnswer = numValue;
                    options = generateNumericOptions(numValue, 5, 10);
                    options = options.map(opt => opt + '%');
                }
                // 檢查是否為比例形式 (如 1:2)
                else if (correctAnswer.includes(':')) {
                    answerIsText = true;
                    const ratios = [
                        '1:2', '1:3', '1:4', '2:3', '2:5', '3:4', '3:5', '3:7', '4:5',
                        '5:6', '5:8', '6:7', '7:8', '7:9', '8:9'
                    ];
                    options = [correctAnswer];
                    
                    // 從其他比例中選擇三個不同的選項
                    while (options.length < 4) {
                        const newRatio = ratios[Math.floor(Math.random() * ratios.length)];
                        if (!options.includes(newRatio)) {
                            options.push(newRatio);
                        }
                    }
                }
                // 檢查是否為分數形式 (如 3/4)
                else if (correctAnswer.includes('/')) {
                    answerIsText = true;
                    const fractions = [
                        '1/2', '1/3', '1/4', '1/5', '2/3', '2/5', '3/4', '3/5', '3/8', '4/5',
                        '5/6', '5/8', '6/7', '7/8', '7/9', '8/9'
                    ];
                    options = [correctAnswer];
                    
                    // 從其他分數中選擇三個不同的選項
                    while (options.length < 4) {
                        const newFraction = fractions[Math.floor(Math.random() * fractions.length)];
                        if (!options.includes(newFraction)) {
                            options.push(newFraction);
                        }
                    }
                }
                // 混合數檢查 (如 "2又1/3")
                else if (correctAnswer.includes('又')) {
                    answerIsText = true;
                    // 生成幾個可能的混合數
                    const mixedNumbers = [
                        '1又1/2', '1又1/3', '1又2/3', '2又1/4', '2又1/3', '2又2/3',
                        '2又3/4', '3又1/4', '3又1/2', '3又3/4'
                    ];
                    options = [correctAnswer];
                    
                    // 從其他混合數中選擇三個不同的選項
                    while (options.length < 4) {
                        const newMixed = mixedNumbers[Math.floor(Math.random() * mixedNumbers.length)];
                        if (!options.includes(newMixed)) {
                            options.push(newMixed);
                        }
                    }
                }
                else {
                    // 嘗試將字串轉換為數字
                    numAnswer = parseFloat(correctAnswer);
                    if (!isNaN(numAnswer)) {
                        options = generateNumericOptions(numAnswer, 5, 10);
                    } else {
                        // 如果無法轉換，則這是一個文本答案
                        answerIsText = true;
                        options = [correctAnswer, '錯誤答案1', '錯誤答案2', '錯誤答案3'];
                    }
                }
            } else {
                // 數字答案
                numAnswer = correctAnswer;
                options = generateNumericOptions(correctAnswer, 5, 10);
            }
            
            // 如果是文本選項，隨機排序
            if (answerIsText) {
                options = shuffleArray(options);
            }
            
            // 更新UI
            questionText.innerHTML = question;
            answerA.textContent = options[0];
            answerB.textContent = options[1];
            answerC.textContent = options[2];
            answerD.textContent = options[3];
            
            // 確定正確選項
            let correctOption;
            if (answerIsText) {
                const correctIndex = options.findIndex(opt => opt === correctAnswer);
                correctOption = String.fromCharCode(65 + correctIndex); // A, B, C, or D
            } else {
                // 找出和正確答案最接近的選項
                let minDiff = Infinity;
                let correctIndex = 0;
                
                for (let i = 0; i < options.length; i++) {
                    let optionValue = options[i];
                    // 移除百分比符號進行比較
                    if (typeof optionValue === 'string' && optionValue.includes('%')) {
                        optionValue = parseInt(optionValue);
                    }
                    
                    const diff = Math.abs(optionValue - numAnswer);
                    if (diff < minDiff) {
                        minDiff = diff;
                        correctIndex = i;
                    }
                }
                
                correctOption = String.fromCharCode(65 + correctIndex); // A, B, C, or D
            }
            
            // 儲存當前問題資訊
            currentQuestion = {
                question,
                answer: correctAnswer,
                options,
                correctOption
            };

            // 添加動畫效果
            questionText.classList.add('animate-float');
            setTimeout(() => {
                questionText.classList.remove('animate-float');
            }, 1000);
        }

        // 生成數字選項
        function generateNumericOptions(correctAnswer, maxVariation, minVariation = 1) {
            let options = [correctAnswer];
            
            // 處理正確答案是0的特殊情況
            if (correctAnswer === 0) {
                while (options.length < 4) {
                    const newOption = Math.floor(Math.random() * 5) + 1; // 1-5
                    if (!options.includes(newOption)) {
                        options.push(newOption);
                    }
                }
                return shuffleArray(options);
            }
            
            // 計算變化範圍
            const variation = Math.max(Math.ceil(correctAnswer * 0.2), minVariation);
            const actualVariation = Math.min(variation, maxVariation);
            
            // 生成錯誤選項
            while (options.length < 4) {
                // 隨機決定加或減，但確保結果為正
                let offset;
                do {
                    offset = Math.floor(Math.random() * actualVariation * 2 + 1) - actualVariation;
                } while (offset === 0 || correctAnswer + offset <= 0);
                
                const newOption = correctAnswer + offset;
                
                // 確保沒有重複選項
                if (!options.includes(newOption)) {
                    options.push(newOption);
                }
            }
            
            return shuffleArray(options);
        }

        // 數組洗牌
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // 處理答案
        function processAnswer(option) {
            if (!isGameRunning || !currentQuestion) return;
            
            const isCorrect = option === currentQuestion.correctOption;
            
            // 獲取選中的選項元素
            const selectedOptionIndex = option.charCodeAt(0) - 65; // A=0, B=1, C=2, D=3
            const selectedOptionElement = document.querySelectorAll('.option-card')[selectedOptionIndex];
            
            // 添加射擊動畫
            selectedOptionElement.classList.add('hit-animation');
            setTimeout(() => {
                selectedOptionElement.classList.remove('hit-animation');
            }, 500);
            
            // 顯示反饋
            feedbackText.textContent = isCorrect 
                ? '✓ 正中目標！' 
                : `✗ 射偏了！正確答案是: ${currentQuestion.correctOption}`;
            
            feedback.className = isCorrect 
                ? 'block p-6 rounded-xl mb-6 text-center font-bold text-xl bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 flex items-center justify-center'
                : 'block p-6 rounded-xl mb-6 text-center font-bold text-xl bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 flex items-center justify-center';
            
            // 添加反饋圖標
            if (isCorrect) {
                feedbackText.innerHTML = `<i class="fas fa-bullseye mr-2"></i> 正中目標！`;
                
                // 播放慶祝動畫
                playCelebrationAnimation();
            } else {
                feedbackText.innerHTML = `<i class="fas fa-times-circle mr-2"></i> 射偏了！正確答案是: ${currentQuestion.correctOption}`;
                
                // 播放打氣動畫
                playEncouragementAnimation();
            }
                
            // 更新分數並添加動畫
            if (isCorrect) {
                score++;
                scoreDisplay.textContent = score;
                scoreDisplay.classList.add('score-up');
                setTimeout(() => {
                    scoreDisplay.classList.remove('score-up');
                }, 700);
            }
            
            // 延遲後生成新問題
            setTimeout(() => {
                if (isGameRunning) {
                    generateQuestion();
                }
            }, 1500);
        }

        // 添加鍵盤支持（用於測試）
        document.addEventListener('keydown', (e) => {
            if (!isGameRunning) return;
            
            const key = e.key.toUpperCase();
            if (key === 'A' || key === 'B' || key === 'C' || key === 'D') {
                processAnswer(key);
            }
        });
    </script>
</body>
</html>
