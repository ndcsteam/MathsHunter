<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸å­—çµç‹© - Microbit æ•¸å­¸éŠæˆ²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            light: '#F59E0B', // ç¥ç€è‰²
                            DEFAULT: '#D97706',
                            dark: '#B45309',
                        },
                        secondary: {
                            light: '#4F46E5', // é›è—è‰²
                            DEFAULT: '#4338CA',
                            dark: '#3730A3',
                        },
                        forest: {
                            light: '#10B981', // ç¿ ç¶ è‰²
                            DEFAULT: '#059669',
                            dark: '#047857',
                        }
                    },
                    fontFamily: {
                        game: ['Comic Sans MS', 'cursive', 'sans-serif']
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'wiggle': 'wiggle 1s ease-in-out infinite',
                        'float': 'float 3s ease-in-out infinite',
                    },
                    keyframes: {
                        wiggle: {
                            '0%, 100%': { transform: 'rotate(-3deg)' },
                            '50%': { transform: 'rotate(3deg)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&display=swap');

        body {
            font-family: 'Baloo 2', cursive, system-ui, sans-serif;
            background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%239C92AC" fill-opacity="0.08"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
        }

        .dark body {
            background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%239C92AC" fill-opacity="0.05"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
        }

        /* ç­”æ¡ˆé¸é …å‹•ç•« */
        .option-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .option-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .option-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.2), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .option-card:hover::after {
            transform: translateX(100%);
        }

        /* å°„æ“Šå‹•ç•« */
        @keyframes hit {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        .hit-animation {
            animation: hit 0.5s ease-out;
        }

        /* å¾—åˆ†å¢åŠ å‹•ç•« */
        @keyframes scoreUp {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); color: #10B981; }
            100% { transform: scale(1); }
        }

        .score-up {
            animation: scoreUp 0.7s ease;
        }

        /* è³ªæ„ŸæŒ‰éˆ• */
        .game-button {
            position: relative;
            transition: all 0.2s ease;
            transform-style: preserve-3d;
        }

        .game-button::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.2);
            transform: translateZ(-1px);
            border-radius: inherit;
            transition: transform 0.2s ease;
        }

        .game-button:active {
            transform: translateY(4px);
        }

        .game-button:active::after {
            transform: translateZ(-1px) translateY(-4px);
        }

        /* æ¨™é¡Œå‹•ç•« */
        .title-animated {
            display: inline-block;
            position: relative;
        }

        .title-animated::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 100%;
            height: 4px;
            background: currentColor;
            transform: scaleX(0);
            transform-origin: right;
            transition: transform 0.5s ease;
        }

        .title-animated:hover::after {
            transform: scaleX(1);
            transform-origin: left;
        }

        /* æ–‡å­—é¡Œæ ¼å¼ */
        .word-problem {
            line-height: 1.6;
            position: relative;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }

        .word-problem::before {
            content: '"';
            font-size: 2.5rem;
            color: rgba(209, 213, 219, 0.5);
            position: absolute;
            left: -0.5rem;
            top: -1rem;
        }

        .word-problem::after {
            content: '"';
            font-size: 2.5rem;
            color: rgba(209, 213, 219, 0.5);
            position: absolute;
            right: -0.5rem;
            bottom: -1.5rem;
        }

        /* æ…¶ç¥å‹•ç•« */
        @keyframes celebrate {
            0% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0; transform: scale(2); }
        }

        .celebration-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            overflow: hidden;
            display: none;
        }

        .celebration-active {
            display: block;
        }

        .celebration-particle {
            position: absolute;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            animation: celebrate 1s ease-out forwards;
        }

        /* æ‰“æ°£å‹•ç•« */
        @keyframes encourage-wave {
            0%, 100% { transform: translateY(0); }
            25% { transform: translateY(-15px); }
            75% { transform: translateY(10px); }
        }

        @keyframes encourage-fade {
            0% { opacity: 0; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0; transform: scale(1.5); }
        }

        .encouragement-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            z-index: 100;
            display: none;
        }

        .encouragement-active {
            display: flex;
        }

        .encouragement-message {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            color: #3730A3;
            background: rgba(255, 255, 255, 0.9);
            padding: 1rem 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: encourage-fade 1.5s ease-in-out forwards;
        }

        .encouragement-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: inline-block;
            animation: encourage-wave 0.7s ease-in-out infinite;
        }

        /* è¨ˆæ™‚å™¨æ¨£å¼ */
        .timer {
            font-size: 2.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .timer-warning {
            color: #F97316 !important; /* æ©™è‰² */
        }

        .timer-danger {
            color: #EF4444 !important; /* çº¢è‰² */
            animation: pulse 0.5s infinite;
        }

        /* éŠæˆ²çµæŸå‹•ç•« */
        @keyframes slideIn {
            0% { transform: translateY(-100%); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .game-over-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.5s ease-out;
        }

        .game-over-panel {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            max-width: 90%;
            width: 500px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-orange-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen">
    <!-- æª¢æ¸¬æ·±è‰²/æ·ºè‰²æ¨¡å¼ -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <!-- æ…¶ç¥å‹•ç•«å®¹å™¨ -->
    <div id="celebration-container" class="celebration-container"></div>
    
    <!-- æ‰“æ°£å‹•ç•«å®¹å™¨ -->
    <div id="encouragement-container" class="encouragement-container">
        <div class="encouragement-message">
            <div class="encouragement-icon">ğŸ’ª</div>
            <div>åŠ æ²¹ï¼å†è©¦ä¸€æ¬¡ï¼</div>
        </div>
    </div>
    
    <!-- éŠæˆ²çµæŸå®¹å™¨ (é è¨­éš±è—) -->
    <div id="game-over-container" class="game-over-container hidden">
        <div class="game-over-panel dark:bg-gray-800">
            <h2 class="text-3xl font-bold mb-4 text-primary-dark dark:text-primary-light">éŠæˆ²çµæŸ!</h2>
            <p class="text-xl mb-6">æ™‚é–“åˆ°ï¼</p>
            
            <div class="flex flex-col items-center mb-6">
                <div class="text-2xl mb-2">ä½ çš„å¾—åˆ†</div>
                <div id="final-score" class="text-5xl font-bold text-primary-dark dark:text-primary-light mb-4">0</div>
                <div id="score-message" class="text-lg italic">å†æ¥å†å²ï¼</div>
            </div>
            
            <button id="restart-button" class="game-button bg-gradient-to-r from-primary-light to-primary px-6 py-3 text-white rounded-full shadow-md hover:shadow-lg flex items-center mx-auto">
                <i class="fas fa-redo-alt mr-2"></i>
                <span>å†ç©ä¸€æ¬¡</span>
            </button>
        </div>
    </div>

    <div class="container mx-auto px-4 py-6">
        <header class="mb-8">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="text-center">
                    <h1 class="text-4xl font-bold text-primary-dark dark:text-primary-light flex items-center">
                        <span class="title-animated mr-2">æ•¸å­—çµç‹©</span>
                        <i class="fas fa-crosshairs text-secondary-light animate-pulse ml-2"></i>
                    </h1>
                    <p class="mt-2 text-gray-600 dark:text-gray-400 italic">
                        ç„æº–æ•¸å­¸å•é¡Œï¼Œæ“Šä¸­æ­£ç¢ºç­”æ¡ˆï¼
                    </p>
                </div>
                <button id="connect-button" class="game-button bg-gradient-to-r from-primary-light to-primary px-6 py-3 text-white rounded-full shadow-lg hover:shadow-xl flex items-center space-x-2 transform hover:scale-105 transition-all">
                    <i class="fas fa-plug mr-2"></i>
                    <span>é€£æ¥çµç‹©è£ç½®</span>
                </button>
            </div>
        </header>

        <div class="max-w-4xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-xl p-6 border-2 border-primary-light dark:border-primary-dark">
            <!-- éŠæˆ²å€åŸŸ -->
            <div id="game-section" class="opacity-50 pointer-events-none">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-gamepad text-secondary-light text-2xl mr-3"></i>
                        <h2 class="text-2xl font-bold text-secondary-dark dark:text-secondary-light">å°„æ“ŠæŒ‘æˆ°</h2>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="bg-gray-100 dark:bg-gray-700 rounded-full px-5 py-2 flex items-center">
                            <i class="fas fa-star text-yellow-500 mr-2"></i>
                            <span class="text-gray-600 dark:text-gray-300 font-medium">çµäººå¾—åˆ†ï¼š</span>
                            <span id="score" class="font-bold text-primary text-2xl ml-2">0</span>
                        </div>
                        <button id="start-button" class="game-button bg-gradient-to-r from-forest-light to-forest px-6 py-3 text-white rounded-full shadow-md hover:shadow-lg flex items-center">
                            <i class="fas fa-play mr-2"></i>
                            <span>é–‹å§‹æŒ‘æˆ°</span>
                        </button>
                    </div>
                </div>

                <!-- è¨ˆæ™‚å™¨ -->
                <div id="timer-container" class="w-full flex justify-center mb-4 hidden">
                    <div class="flex items-center bg-gray-100 dark:bg-gray-700 px-6 py-2 rounded-full">
                        <i class="fas fa-hourglass-half text-yellow-500 text-2xl mr-3"></i>
                        <div id="timer" class="text-3xl font-bold text-gray-700 dark:text-gray-300">60</div>
                    </div>
                </div>

                <!-- å•é¡Œå±•ç¤ºå€ - çµå ´ -->
                <div id="question-container" class="p-8 bg-gradient-to-br from-amber-50 to-orange-100 dark:from-gray-900 dark:to-gray-800 rounded-xl mb-6 shadow-inner border border-amber-200 dark:border-gray-700">
                    <div id="question-text" class="text-3xl font-bold text-center mb-8 py-3 px-6 bg-white dark:bg-gray-800 rounded-xl shadow-md inline-block mx-auto animate-float">
                        æº–å‚™å¥½å¾Œé»æ“Šã€Œé–‹å§‹æŒ‘æˆ°ã€æŒ‰éˆ•
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="option-card bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md hover:bg-amber-50 dark:hover:bg-gray-700 border-2 border-transparent hover:border-primary-light dark:hover:border-primary cursor-pointer">
                            <div class="flex items-center">
                                <div class="h-12 w-12 flex items-center justify-center bg-primary-light text-white rounded-full mr-4 shadow-md">
                                    <span class="text-xl font-bold">A</span>
                                </div>
                                <div id="answer-a" class="text-2xl font-medium">-</div>
                            </div>
                        </div>
                        <div class="option-card bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md hover:bg-amber-50 dark:hover:bg-gray-700 border-2 border-transparent hover:border-primary-light dark:hover:border-primary cursor-pointer">
                            <div class="flex items-center">
                                <div class="h-12 w-12 flex items-center justify-center bg-primary-light text-white rounded-full mr-4 shadow-md">
                                    <span class="text-xl font-bold">B</span>
                                </div>
                                <div id="answer-b" class="text-2xl font-medium">-</div>
                            </div>
                        </div>
                        <div class="option-card bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md hover:bg-amber-50 dark:hover:bg-gray-700 border-2 border-transparent hover:border-primary-light dark:hover:border-primary cursor-pointer">
                            <div class="flex items-center">
                                <div class="h-12 w-12 flex items-center justify-center bg-primary-light text-white rounded-full mr-4 shadow-md">
                                    <span class="text-xl font-bold">C</span>
                                </div>
                                <div id="answer-c" class="text-2xl font-medium">-</div>
                            </div>
                        </div>
                        <div class="option-card bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md hover:bg-amber-50 dark:hover:bg-gray-700 border-2 border-transparent hover:border-primary-light dark:hover:border-primary cursor-pointer">
                            <div class="flex items-center">
                                <div class="h-12 w-12 flex items-center justify-center bg-primary-light text-white rounded-full mr-4 shadow-md">
                                    <span class="text-xl font-bold">D</span>
                                </div>
                                <div id="answer-d" class="text-2xl font-medium">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="feedback" class="hidden p-6 rounded-xl mb-6 text-center font-bold text-xl flex items-center justify-center">
                    <span id="feedback-text"></span>
                </div>
            </div>
        </div>

        <footer class="mt-6 text-center text-gray-500 dark:text-gray-400 text-sm">
            <p>æ•¸å­—çµç‹© &copy; 2023 - å°äº”å°å…­æ•¸å­¸ç·´ç¿’éŠæˆ²</p>
        </footer>
    </div>

    <!-- éŸ³æ•ˆå…ƒç´  -->
    <audio id="countdown-audio" src="./audio/CountDown.mp3" preload="auto"></audio>

    <script>
        // éŠæˆ²è®Šæ•¸
        let port;
        let reader;
        let inputDone;
        let score = 0;
        let currentQuestion = null;
        let isGameRunning = false;
        let gameEnabled = false;
        let timerInterval = null;
        let timeLeft = 60; // éŠæˆ²æ™‚é–“60ç§’
        let countdownAudio = null;

        // DOMå…ƒç´ 
        const connectButton = document.getElementById('connect-button');
        const startButton = document.getElementById('start-button');
        const scoreDisplay = document.getElementById('score');
        const questionText = document.getElementById('question-text');
        const answerA = document.getElementById('answer-a');
        const answerB = document.getElementById('answer-b');
        const answerC = document.getElementById('answer-c');
        const answerD = document.getElementById('answer-d');
        const gameSection = document.getElementById('game-section');
        const feedback = document.getElementById('feedback');
        const feedbackText = document.getElementById('feedback-text');
        const celebrationContainer = document.getElementById('celebration-container');
        const encouragementContainer = document.getElementById('encouragement-container');
        const timerContainer = document.getElementById('timer-container');
        const timerDisplay = document.getElementById('timer');
        const gameOverContainer = document.getElementById('game-over-container');
        const finalScoreDisplay = document.getElementById('final-score');
        const scoreMessageDisplay = document.getElementById('score-message');
        const restartButton = document.getElementById('restart-button');
        const countdownAudioElement = document.getElementById('countdown-audio');

        // é€£æ¥åˆ°Microbit
        connectButton.addEventListener('click', async () => {
            try {
                // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´Web Serial API
                if (!('serial' in navigator)) {
                    showNotification('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´Web Serial APIã€‚è«‹ä½¿ç”¨Chromeæˆ–Edgeç€è¦½å™¨ã€‚', true);
                    return;
                }

                // è«‹æ±‚è¨ªå•Serialç«¯å£
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                
                // è¨­ç½®è®€å–å™¨
                reader = port.readable.getReader();
                
                // æ›´æ–°é€£æ¥ç‹€æ…‹
                showNotification('å·²é€£æ¥ - çµç‹©è£ç½®æº–å‚™å°±ç·’ï¼', false);
                connectButton.innerHTML = '<i class="fas fa-check-circle mr-2"></i><span>å·²é€£æ¥</span>';
                connectButton.disabled = true;
                connectButton.classList.remove('from-primary-light', 'to-primary');
                connectButton.classList.add('from-green-500', 'to-green-600');
                
                // å•Ÿç”¨éŠæˆ²å€åŸŸ
                gameSection.classList.remove('opacity-50', 'pointer-events-none');
                gameEnabled = true;

                // é–‹å§‹è®€å–æ•¸æ“š
                readData();
            } catch (error) {
                console.error('é€£æ¥éŒ¯èª¤:', error);
                showNotification(`é€£æ¥éŒ¯èª¤: ${error.message}`, true);
            }
        });

        // è¨ˆæ™‚å™¨åŠŸèƒ½
        function startTimer() {
            // é¡¯ç¤ºè¨ˆæ™‚å™¨
            timerContainer.classList.remove('hidden');
            timeLeft = 60; // é‡ç½®æ™‚é–“
            updateTimerDisplay();
            
            // å•Ÿå‹•è¨ˆæ™‚å™¨
            clearInterval(timerInterval); // æ¸…é™¤èˆŠè¨ˆæ™‚å™¨
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                // ç•¶æ™‚é–“ä½æ–¼10ç§’æ™‚ï¼Œæ·»åŠ è­¦å‘Šæ¨£å¼
                if (timeLeft <= 10) {
                    timerDisplay.classList.add('timer-danger');
                } else if (timeLeft <= 20) {
                    timerDisplay.classList.add('timer-warning');
                    timerDisplay.classList.remove('timer-danger');
                } else {
                    timerDisplay.classList.remove('timer-warning', 'timer-danger');
                }
                
                // æ™‚é–“çµæŸæ™‚
                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        // æ›´æ–°è¨ˆæ™‚å™¨é¡¯ç¤º
        function updateTimerDisplay() {
            timerDisplay.textContent = timeLeft;
        }

        // çµæŸéŠæˆ²
        function endGame() {
            // åœæ­¢è¨ˆæ™‚å™¨
            clearInterval(timerInterval);
            
            // åœæ­¢éŸ³æ¨‚
            if (countdownAudio) {
                countdownAudio.pause();
                countdownAudio.currentTime = 0;
            }
            
            // æ›´æ–°æœ€çµ‚åˆ†æ•¸
            finalScoreDisplay.textContent = score;
            
            // è¨­ç½®æœ€çµ‚åˆ†æ•¸è¨Šæ¯
            if (score >= 20) {
                scoreMessageDisplay.textContent = 'å¤ªå²å®³äº†ï¼ä½ æ˜¯æ•¸å­¸å¤©æ‰ï¼';
            } else if (score >= 15) {
                scoreMessageDisplay.textContent = 'å¥½æ£’ï¼ä½ çš„æ•¸å­¸èƒ½åŠ›å¾ˆå¼·ï¼';
            } else if (score >= 10) {
                scoreMessageDisplay.textContent = 'åšå¾—å¥½ï¼ç¹¼çºŒåŠªåŠ›ï¼';
            } else if (score >= 5) {
                scoreMessageDisplay.textContent = 'åŠ æ²¹ï¼ä½ å¯ä»¥åšå¾—æ›´å¥½ï¼';
            } else {
                scoreMessageDisplay.textContent = 'åˆ¥ç°å¿ƒï¼Œç¹¼çºŒç·´ç¿’ï¼Œä½ æœƒé€²æ­¥çš„ï¼';
            }
            
            // é¡¯ç¤ºéŠæˆ²çµæŸç•«é¢
            gameOverContainer.classList.remove('hidden');
            
            // åœæ­¢éŠæˆ²
            isGameRunning = false;
        }

        // é‡æ–°é–‹å§‹éŠæˆ²
        restartButton.addEventListener('click', () => {
            // éš±è—éŠæˆ²çµæŸç•«é¢
            gameOverContainer.classList.add('hidden');
            
            // é‡ç½®åˆ†æ•¸
            score = 0;
            scoreDisplay.textContent = '0';
            
            // å•Ÿå‹•æ–°éŠæˆ²
            startGame();
        });

        // é¡¯ç¤ºé€šçŸ¥ï¼ˆåƒ…åœ¨æ§åˆ¶å°ï¼‰
        function showNotification(message, isError) {
            const statusType = isError ? 'error' : 'info';
            const statusPrefix = isError ? 'éŒ¯èª¤: ' : 'ç‹€æ…‹: ';
            
            if (isError) {
                console.error(statusPrefix + message);
            } else {
                console.log(statusPrefix + message);
            }
        }

        // è®€å–Microbitæ•¸æ“š
        async function readData() {
            while (true) {
                try {
                    const { value, done } = await reader.read();
                    if (done) {
                        // æµå·²é—œé–‰
                        break;
                    }
                    // å°‡æ¥æ”¶åˆ°çš„æ•¸æ“šè§£ç¢¼ç‚ºæ–‡æœ¬
                    const valueString = new TextDecoder().decode(value).trim();
                    console.log("æ¥æ”¶åˆ°çš„æ•¸æ“š:", valueString);
                    // è™•ç†æ¥æ”¶åˆ°çš„é¸é …
                    if (valueString === 'A' || valueString === 'B' || valueString === 'C' || valueString === 'D') {
                        processAnswer(valueString);
                    }
                } catch (error) {
                    console.error('è®€å–éŒ¯èª¤:', error);
                    break;
                }
            }
        }

        // é–‹å§‹éŠæˆ²
        function startGame() {
            if (!gameEnabled && !confirm('ä½ å°šæœªé€£æ¥çµç‹©è£ç½®ã€‚è¦ç¹¼çºŒå—ï¼Ÿ')) {
                return;
            }
            
            isGameRunning = true;
            score = 0;
            scoreDisplay.textContent = '0';
            startButton.innerHTML = '<i class="fas fa-forward mr-2"></i><span>ä¸‹ä¸€é¡Œ</span>';
            
            // æ’­æ”¾éŸ³æ¨‚
            try {
                // å˜—è©¦æ’­æ”¾éŸ³æ¨‚
                countdownAudio = new Audio('./audio/CountDown.mp3');
                countdownAudio.play().catch(error => {
                    console.error('ç„¡æ³•æ’­æ”¾éŸ³é »:', error);
                    // å˜—è©¦ä½¿ç”¨HTML audioå…ƒç´ 
                    countdownAudioElement.play().catch(err => {
                        console.error('å…©ç¨®æ–¹æ³•éƒ½ç„¡æ³•æ’­æ”¾éŸ³é »:', err);
                    });
                });
            } catch (error) {
                console.error('æ’­æ”¾éŸ³é »æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
            
            // å•Ÿå‹•è¨ˆæ™‚å™¨
            startTimer();
            
            // ç”Ÿæˆç¬¬ä¸€å€‹å•é¡Œ
            generateQuestion();
        }

        // é»æ“Šé–‹å§‹æŒ‰éˆ•
        startButton.addEventListener('click', () => {
            if (isGameRunning) {
                // å¦‚æœéŠæˆ²å·²ç¶“åœ¨é‹è¡Œï¼Œå‰‡ç”Ÿæˆæ–°å•é¡Œ
                generateQuestion();
            } else {
                // é–‹å§‹æ–°éŠæˆ²
                startGame();
            }
        });

        // æ…¶ç¥å‹•ç•«
        function playCelebrationAnimation() {
            celebrationContainer.innerHTML = ''; // æ¸…ç©ºä¹‹å‰çš„ç²’å­
            celebrationContainer.classList.add('celebration-active');
            
            // å‰µå»ºå½©è‰²ç²’å­
            const colors = [
                '#10B981', // ç¶ è‰²
                '#3B82F6', // è—è‰²
                '#F59E0B', // ç¥ç€è‰²
                '#EC4899', // ç²‰ç´…è‰²
                '#8B5CF6', // ç´«è‰²
                '#F43F5E', // ç´…è‰²
                '#FBBF24'  // é»ƒè‰²
            ];
            
            const particleCount = 60; // ç²’å­æ•¸é‡
            
            for (let i = 0; i < particleCount; i++) {
                // å‰µå»ºç²’å­å…ƒç´ 
                const particle = document.createElement('div');
                particle.classList.add('celebration-particle');
                
                // éš¨æ©Ÿä½ç½®
                const x = Math.random() * window.innerWidth;
                const y = Math.random() * window.innerHeight;
                
                // éš¨æ©Ÿå¤§å°
                const size = Math.random() * 10 + 8;
                
                // éš¨æ©Ÿé¡è‰²
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                // éš¨æ©Ÿå»¶é²
                const delay = Math.random() * 1.5;
                
                // è¨­ç½®æ¨£å¼
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.backgroundColor = color;
                particle.style.animationDelay = `${delay}s`;
                
                // æ·»åŠ åˆ°å®¹å™¨
                celebrationContainer.appendChild(particle);
            }
            
            // ä¸€æ®µæ™‚é–“å¾Œç§»é™¤å‹•ç•«
            setTimeout(() => {
                celebrationContainer.classList.remove('celebration-active');
            }, 2500);
        }

        // æ‰“æ°£å‹•ç•«
        function playEncouragementAnimation() {
            encouragementContainer.classList.add('encouragement-active');
            
            // éš¨æ©Ÿé¼“å‹µçŸ­èª
            const messages = [
                'åŠ æ²¹ï¼å†è©¦ä¸€æ¬¡ï¼',
                'åˆ¥æ”¾æ£„ï¼ä½ èƒ½åšåˆ°ï¼',
                'ä¸‹ä¸€é¡Œæœƒæ›´å¥½ï¼',
                'ç¹¼çºŒåŠªåŠ›ï¼'
            ];
            
            // éš¨æ©Ÿè¡¨æƒ…ç¬¦è™Ÿ
            const emojis = ['ğŸ’ª', 'ğŸ”¥', 'âœ¨', 'ğŸ“š', 'ğŸ§ '];
            
            // éš¨æ©Ÿé¸æ“‡ä¸€æ¢è¨Šæ¯å’Œè¡¨æƒ…ç¬¦è™Ÿ
            const message = messages[Math.floor(Math.random() * messages.length)];
            const emoji = emojis[Math.floor(Math.random() * emojis.length)];
            
            // æ›´æ–°å…§å®¹
            const messageElement = encouragementContainer.querySelector('.encouragement-message div:last-child');
            const emojiElement = encouragementContainer.querySelector('.encouragement-icon');
            
            if (messageElement && emojiElement) {
                messageElement.textContent = message;
                emojiElement.textContent = emoji;
            }
            
            // ä¸€æ®µæ™‚é–“å¾Œç§»é™¤å‹•ç•«
            setTimeout(() => {
                encouragementContainer.classList.remove('encouragement-active');
            }, 1500);
        }

        // é¡Œç›®é¡åˆ¥èˆ‡ç”Ÿæˆ
        const questionTypes = [
            // 0. åŸºæœ¬å››å‰‡é‹ç®—(è¼ƒç°¡å–®)
            {
                name: "åŸºæœ¬é‹ç®—",
                icon: "calculator",
                generator: function() {
                    const operations = ['+', '-', 'Ã—', 'Ã·'];
                    const op = operations[Math.floor(Math.random() * 4)];
                    
                    let num1, num2, answer, question;
                    
                    switch(op) {
                        case '+': // åŠ æ³•
                            num1 = Math.floor(Math.random() * 50) + 1;
                            num2 = Math.floor(Math.random() * 50) + 1;
                            answer = num1 + num2;
                            question = `${num1} + ${num2} = ?`;
                            break;
                            
                        case '-': // æ¸›æ³•(ç¢ºä¿çµæœç‚ºæ­£æ•¸)
                            num1 = Math.floor(Math.random() * 50) + 51; // 51-100
                            num2 = Math.floor(Math.random() * 50) + 1;  // 1-50
                            answer = num1 - num2;
                            question = `${num1} - ${num2} = ?`;
                            break;
                            
                        case 'Ã—': // ä¹˜æ³•
                            num1 = Math.floor(Math.random() * 10) + 1;
                            num2 = Math.floor(Math.random() * 10) + 1;
                            answer = num1 * num2;
                            question = `${num1} Ã— ${num2} = ?`;
                            break;
                            
                        case 'Ã·': // é™¤æ³•(ç¢ºä¿èƒ½æ•´é™¤)
                            num2 = Math.floor(Math.random() * 10) + 1; // é™¤æ•¸ 1-10
                            answer = Math.floor(Math.random() * 10) + 1; // å•† 1-10
                            num1 = num2 * answer; // è¢«é™¤æ•¸
                            question = `${num1} Ã· ${num2} = ?`;
                            break;
                    }
                    
                    return { question, answer };
                }
            },
            
            // 1. é«˜éšè¨ˆç®—(è¼ƒè¤‡é›œ)
            {
                name: "é€²éšé‹ç®—",
                icon: "square-root-variable",
                generator: function() {
                    const subTypes = ['æ··åˆé‹ç®—', 'åˆ†æ•¸', 'å°æ•¸'];
                    const subType = subTypes[Math.floor(Math.random() * subTypes.length)];
                    
                    let question, answer;
                    
                    switch(subType) {
                        case 'æ··åˆé‹ç®—':
                            // ç”Ÿæˆå…©æ­¥é‹ç®—ï¼Œå¦‚ 3x4+5 æˆ– 20Ã·4-2
                            const ops = ['+', '-'];
                            const op = ops[Math.floor(Math.random() * ops.length)];
                            
                            // å…ˆç®—ä¹˜/é™¤éƒ¨åˆ†
                            let num1, num2, num3, midResult;
                            
                            if (Math.random() < 0.5) { // ä¹˜æ³•å„ªå…ˆ
                                num1 = Math.floor(Math.random() * 10) + 1; // 1-10
                                num2 = Math.floor(Math.random() * 10) + 1; // 1-10
                                midResult = num1 * num2;
                                
                                if (op === '+') {
                                    num3 = Math.floor(Math.random() * 20) + 1; // 1-20
                                    answer = midResult + num3;
                                    question = `${num1} Ã— ${num2} + ${num3} = ?`;
                                } else {
                                    num3 = Math.floor(Math.random() * midResult) + 1; // ç¢ºä¿çµæœç‚ºæ­£
                                    answer = midResult - num3;
                                    question = `${num1} Ã— ${num2} - ${num3} = ?`;
                                }
                            } else { // é™¤æ³•å„ªå…ˆ
                                num2 = Math.floor(Math.random() * 9) + 2; // é™¤æ•¸ 2-10
                                answer = Math.floor(Math.random() * 9) + 1; // å•† 1-9
                                
                                if (op === '+') {
                                    num3 = Math.floor(Math.random() * 20) + 1; // 1-20
                                    midResult = answer - num3; // å…ˆç®—å‡ºä¸­é–“çµæœï¼Œç¢ºä¿æœ€çµ‚ç­”æ¡ˆç‚ºæ•´æ•¸
                                    num1 = midResult * num2; // è¢«é™¤æ•¸
                                    answer = midResult + num3;
                                    question = `${num1} Ã· ${num2} + ${num3} = ?`;
                                } else {
                                    num3 = Math.floor(Math.random() * 10) + 1; // 1-10
                                    midResult = answer + num3; // å…ˆç®—å‡ºä¸­é–“çµæœï¼Œç¢ºä¿æœ€çµ‚ç­”æ¡ˆç‚ºæ•´æ•¸
                                    num1 = midResult * num2; // è¢«é™¤æ•¸
                                    answer = midResult - num3;
                                    question = `${num1} Ã· ${num2} - ${num3} = ?`;
                                }
                            }
                            break;
                            
                        case 'åˆ†æ•¸':
                            // ç°¡å–®åˆ†æ•¸åŠ æ¸›æ³•ï¼Œä½¿ç”¨ç›¸åŒåˆ†æ¯
                            const denominator = Math.floor(Math.random() * 8) + 2; // åˆ†æ¯ 2-9
                            const numer1 = Math.floor(Math.random() * (denominator - 1)) + 1; // åˆ†å­1
                            let numer2;
                            
                            if (Math.random() < 0.5) { // åŠ æ³•
                                numer2 = Math.floor(Math.random() * (denominator - 1)) + 1; // åˆ†å­2
                                answer = numer1 + numer2;
                                // æª¢æŸ¥æ˜¯å¦éœ€è¦åŒ–ç°¡
                                if (answer > denominator) {
                                    const whole = Math.floor(answer / denominator);
                                    const remainder = answer % denominator;
                                    if (remainder === 0) {
                                        answer = whole;
                                        question = `\\(\\frac{${numer1}}{${denominator}} + \\frac{${numer2}}{${denominator}} = ?\\)`;
                                    } else {
                                        answer = `${whole}åˆ${remainder}/${denominator}`;
                                        question = `\\(\\frac{${numer1}}{${denominator}} + \\frac{${numer2}}{${denominator}} = ?\\)`;
                                    }
                                } else {
                                    answer = `${answer}/${denominator}`;
                                    question = `\\(\\frac{${numer1}}{${denominator}} + \\frac{${numer2}}{${denominator}} = ?\\)`;
                                }
                            } else { // æ¸›æ³•ï¼Œç¢ºä¿çµæœç‚ºæ­£
                                numer2 = Math.floor(Math.random() * numer1) + 1; // ç¢ºä¿ numer1 > numer2
                                answer = numer1 - numer2;
                                answer = `${answer}/${denominator}`;
                                question = `\\(\\frac{${numer1}}{${denominator}} - \\frac{${numer2}}{${denominator}} = ?\\)`;
                            }
                            
                            // å°‡æ•¸å­¸ç¬¦è™Ÿè½‰æ›ç‚ºé¡¯ç¤ºæ ¼å¼
                            question = `<span class="text-2xl">
                                          ${numer1}/${denominator} ${Math.random() < 0.5 ? '+' : '-'} ${numer2}/${denominator} = ?
                                        </span>`;
                            break;
                            
                        case 'å°æ•¸':
                            // ä¸€ä½å°æ•¸åŠ æ¸›æ³•
                            const int1 = Math.floor(Math.random() * 20) + 1; // æ•´æ•¸éƒ¨åˆ† 1-20
                            const dec1 = Math.floor(Math.random() * 10); // å°æ•¸éƒ¨åˆ† 0-9
                            const int2 = Math.floor(Math.random() * 20) + 1; // æ•´æ•¸éƒ¨åˆ† 1-20
                            const dec2 = Math.floor(Math.random() * 10); // å°æ•¸éƒ¨åˆ† 0-9
                            
                            const decNum1 = int1 + dec1/10;
                            const decNum2 = int2 + dec2/10;
                            
                            if (Math.random() < 0.5) { // åŠ æ³•
                                answer = (decNum1 + decNum2).toFixed(1);
                                answer = parseFloat(answer); // ç§»é™¤ä¸å¿…è¦çš„é›¶
                                question = `${decNum1.toFixed(1)} + ${decNum2.toFixed(1)} = ?`;
                            } else { // æ¸›æ³•ï¼Œç¢ºä¿çµæœç‚ºæ­£
                                if (decNum1 >= decNum2) {
                                    answer = (decNum1 - decNum2).toFixed(1);
                                    answer = parseFloat(answer); // ç§»é™¤ä¸å¿…è¦çš„é›¶
                                    question = `${decNum1.toFixed(1)} - ${decNum2.toFixed(1)} = ?`;
                                } else {
                                    answer = (decNum2 - decNum1).toFixed(1);
                                    answer = parseFloat(answer); // ç§»é™¤ä¸å¿…è¦çš„é›¶
                                    question = `${decNum2.toFixed(1)} - ${decNum1.toFixed(1)} = ?`;
                                }
                            }
                            break;
                    }
                    
                    return { question, answer };
                }
            },
            
            // 2. ç°¡å–®æ‡‰ç”¨é¡Œ
            {
                name: "æ—¥å¸¸æ‡‰ç”¨",
                icon: "person-walking",
                generator: function() {
                    const topics = [
                        'è³¼ç‰©è¨ˆç®—', 
                        'æ™‚é–“å•é¡Œ', 
                        'é•·åº¦æ¸¬é‡', 
                        'é‡é‡è¨ˆç®—',
                        'é€Ÿåº¦å•é¡Œ'
                    ];
                    const topic = topics[Math.floor(Math.random() * topics.length)];
                    
                    let question, answer, story;
                    
                    switch(topic) {
                        case 'è³¼ç‰©è¨ˆç®—':
                            // ç”Ÿæˆè³¼ç‰©æƒ…å¢ƒé¡Œ
                            const items = ['é‰›ç­†', 'æ©¡çš®æ“¦', 'è¨˜äº‹æœ¬', 'é‹¼ç­†', 'æ°´å½©ç­†', 'æ›¸åŒ…', 'å°º', 'æ–‡å…·ç›’'];
                            const item1 = items[Math.floor(Math.random() * items.length)];
                            let item2;
                            do {
                                item2 = items[Math.floor(Math.random() * items.length)];
                            } while (item2 === item1);
                            
                            const price1 = Math.floor(Math.random() * 20) + 5; // 5-24å…ƒ
                            const price2 = Math.floor(Math.random() * 30) + 10; // 10-39å…ƒ
                            const quantity1 = Math.floor(Math.random() * 5) + 1; // 1-5å€‹
                            const quantity2 = Math.floor(Math.random() * 5) + 1; // 1-5å€‹
                            
                            const total = price1 * quantity1 + price2 * quantity2;
                            const money = Math.ceil(total / 10) * 10 + Math.floor(Math.random() * 5) * 10; // ç¢ºä¿è¶³å¤ æ‰¾é›¶
                            const change = money - total;
                            
                            const questionTypes = ['total', 'change'];
                            const questionType = questionTypes[Math.floor(Math.random() * questionTypes.length)];
                            
                            story = `å°æ˜å»æ–‡å…·åº—è²·äº†${quantity1}æ”¯${item1}ï¼Œæ¯æ”¯${price1}å…ƒï¼Œå’Œ${quantity2}å€‹${item2}ï¼Œæ¯å€‹${price2}å…ƒã€‚`;
                            
                            if (questionType === 'total') {
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>å°æ˜ä¸€å…±éœ€è¦ä»˜å¤šå°‘éŒ¢ï¼Ÿ</div>`;
                                answer = total;
                            } else {
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}å°æ˜ä»˜äº†${money}å…ƒï¼Œæ‡‰è©²æ‰¾å›å¤šå°‘éŒ¢ï¼Ÿ</div>`;
                                answer = change;
                            }
                            break;
                            
                        case 'æ™‚é–“å•é¡Œ':
                            // ç”Ÿæˆæ™‚é–“è¨ˆç®—é¡Œ
                            const hour1 = Math.floor(Math.random() * 12) + 1; // 1-12é»
                            const minute1 = Math.floor(Math.random() * 12) * 5; // 0, 5, 10, ..., 55åˆ†
                            
                            // ç”¢ç”Ÿä¸€å€‹æ™‚é–“é–“éš”ï¼Œä»¥åˆ†é˜è¨ˆ
                            const interval = (Math.floor(Math.random() * 12) + 1) * 15; // 15, 30, 45, ..., 180åˆ†é˜
                            
                            // è¨ˆç®—çµæŸæ™‚é–“
                            let totalMinutes = hour1 * 60 + minute1 + interval;
                            let hour2 = Math.floor(totalMinutes / 60);
                            if (hour2 > 12) hour2 -= 12; // ä½¿ç”¨12å°æ™‚åˆ¶
                            if (hour2 === 0) hour2 = 12;
                            const minute2 = totalMinutes % 60;
                            
                            const activities = ['çœ‹é›»å½±', 'è¸¢è¶³çƒ', 'ä¸Šæ•¸å­¸èª²', 'ç•«ç•«', 'å½ˆé‹¼ç´', 'ç©é›»è…¦éŠæˆ²', 'è®€æ›¸'];
                            const activity = activities[Math.floor(Math.random() * activities.length)];
                            
                            const minute1Str = minute1 < 10 ? `0${minute1}` : minute1;
                            const minute2Str = minute2 < 10 ? `0${minute2}` : minute2;
                            
                            story = `å°è¯åœ¨ä¸‹åˆ${hour1}:${minute1Str}é–‹å§‹${activity}ï¼Œä¸€ç›´åˆ°${hour2}:${minute2Str}çµæŸã€‚`;
                            question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>å°è¯${activity}äº†å¤šå°‘åˆ†é˜ï¼Ÿ</div>`;
                            answer = interval;
                            break;
                            
                        case 'é•·åº¦æ¸¬é‡':
                            // ç”Ÿæˆé•·åº¦ã€è·é›¢è¨ˆç®—é¡Œ
                            const lengths = [
                                { unit: 'å…¬åˆ†', value: Math.floor(Math.random() * 50) + 20 }, // 20-69å…¬åˆ†
                                { unit: 'å…¬åˆ†', value: Math.floor(Math.random() * 30) + 10 }  // 10-39å…¬åˆ†
                            ];
                            
                            const objectTypes = ['ç¹©å­', 'å¸ƒæ¢', 'æœ¨æ¿', 'ç´™æ¢'];
                            const objectType = objectTypes[Math.floor(Math.random() * objectTypes.length)];
                            
                            if (Math.random() < 0.5) { // åŠ æ³•
                                story = `å°èŠ³æœ‰ä¸€æ¢${lengths[0].value}${lengths[0].unit}é•·çš„${objectType}ï¼Œå°å¼·æœ‰ä¸€æ¢${lengths[1].value}${lengths[1].unit}é•·çš„${objectType}ã€‚`;
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>å¦‚æœæŠŠå…©æ¢${objectType}é€£æ¥èµ·ä¾†ï¼Œç¸½é•·åº¦æ˜¯å¤šå°‘${lengths[0].unit}ï¼Ÿ</div>`;
                                answer = lengths[0].value + lengths[1].value;
                            } else { // æ¸›æ³•
                                const total = lengths[0].value + lengths[1].value;
                                story = `å°èŠ³æœ‰ä¸€æ¢${total}${lengths[0].unit}é•·çš„${objectType}ï¼Œå¥¹å‰ªä¸‹äº†${lengths[1].value}${lengths[1].unit}ã€‚`;
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>å‰©ä¸‹çš„${objectType}é•·åº¦æ˜¯å¤šå°‘${lengths[0].unit}ï¼Ÿ</div>`;
                                answer = lengths[0].value;
                            }
                            break;
                            
                        case 'é‡é‡è¨ˆç®—':
                            // ç”Ÿæˆé‡é‡è¨ˆç®—é¡Œ
                            const weights = [
                                { unit: 'å…¬æ–¤', value: Math.floor(Math.random() * 10) + 1 }, // 1-10å…¬æ–¤
                                { unit: 'å…¬æ–¤', value: Math.floor(Math.random() * 5) + 1 }   // 1-5å…¬æ–¤
                            ];
                            
                            const fruitTypes = ['è˜‹æœ', 'æ©˜å­', 'é¦™è•‰', 'è¥¿ç“œ', 'é³³æ¢¨'];
                            const fruitType = fruitTypes[Math.floor(Math.random() * fruitTypes.length)];
                            
                            if (Math.random() < 0.5) { // ä¹˜æ³•
                                const quantity = Math.floor(Math.random() * 5) + 2; // 2-6å€‹
                                story = `ä¸€å€‹${fruitType}çš„é‡é‡æ˜¯${weights[0].value}${weights[0].unit}ã€‚`;
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>${quantity}å€‹${fruitType}çš„ç¸½é‡é‡æ˜¯å¤šå°‘${weights[0].unit}ï¼Ÿ</div>`;
                                answer = weights[0].value * quantity;
                            } else { // åŠ æ³•æˆ–æ¸›æ³•
                                if (Math.random() < 0.5) { // åŠ æ³•
                                    const fruit2Types = fruitTypes.filter(f => f !== fruitType);
                                    const fruit2Type = fruit2Types[Math.floor(Math.random() * fruit2Types.length)];
                                    story = `å°æ˜è²·äº†${weights[0].value}${weights[0].unit}çš„${fruitType}å’Œ${weights[1].value}${weights[1].unit}çš„${fruit2Type}ã€‚`;
                                    question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>ä»–ä¸€å…±è²·äº†å¤šå°‘${weights[0].unit}çš„æ°´æœï¼Ÿ</div>`;
                                    answer = weights[0].value + weights[1].value;
                                } else { // æ¸›æ³•
                                    const total = weights[0].value + weights[1].value;
                                    story = `å°æ˜è²·äº†${total}${weights[0].unit}çš„${fruitType}ï¼Œåƒæ‰äº†${weights[1].value}${weights[1].unit}ã€‚`;
                                    question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>é‚„å‰©ä¸‹å¤šå°‘${weights[0].unit}çš„${fruitType}ï¼Ÿ</div>`;
                                    answer = weights[0].value;
                                }
                            }
                            break;
                            
                        case 'é€Ÿåº¦å•é¡Œ':
                            // ç”Ÿæˆç°¡å–®é€Ÿåº¦è¨ˆç®—é¡Œ
                            const speeds = [
                                { unit: 'å…¬é‡Œ/å°æ™‚', value: Math.floor(Math.random() * 30) + 30 }, // 30-59å…¬é‡Œ/å°æ™‚
                                { unit: 'å°æ™‚', value: Math.floor(Math.random() * 3) + 1 }        // 1-3å°æ™‚
                            ];
                            
                            const vehicles = ['è…³è¸è»Š', 'æ±½è»Š', 'å…¬è»Š', 'ç«è»Š'];
                            const vehicle = vehicles[Math.floor(Math.random() * vehicles.length)];
                            
                            // é€Ÿåº¦Ã—æ™‚é–“=è·é›¢
                            const distance = speeds[0].value * speeds[1].value;
                            
                            if (Math.random() < 0.5) { // æ±‚è·é›¢
                                story = `å°æ˜ä¹˜å${vehicle}ï¼Œä»¥æ¯å°æ™‚${speeds[0].value}å…¬é‡Œçš„é€Ÿåº¦è¡Œé§›äº†${speeds[1].value}å°æ™‚ã€‚`;
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>å°æ˜è¡Œé§›äº†å¤šå°‘å…¬é‡Œï¼Ÿ</div>`;
                                answer = distance;
                            } else { // æ±‚æ™‚é–“
                                story = `å°æ˜ä¹˜å${vehicle}ï¼Œä»¥æ¯å°æ™‚${speeds[0].value}å…¬é‡Œçš„é€Ÿåº¦è¡Œé§›ï¼Œä¸€å…±è¡Œé§›äº†${distance}å…¬é‡Œã€‚`;
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>å°æ˜è¡Œé§›äº†å¤šå°‘å°æ™‚ï¼Ÿ</div>`;
                                answer = speeds[1].value;
                            }
                            break;
                    }
                    
                    return { question, answer };
                }
            },
            
            // 3. é€²éšæ‡‰ç”¨é¡Œ
            {
                name: "é€²éšæ‡‰ç”¨",
                icon: "brain",
                generator: function() {
                    const topics = [
                        'ç™¾åˆ†æ¯”', 
                        'æ¯”ä¾‹å•é¡Œ', 
                        'é¢ç©è¨ˆç®—', 
                        'é‚è¼¯æ¨ç†'
                    ];
                    const topic = topics[Math.floor(Math.random() * topics.length)];
                    
                    let question, answer, story;
                    
                    switch(topic) {
                        case 'ç™¾åˆ†æ¯”':
                            // ç”Ÿæˆç™¾åˆ†æ¯”è¨ˆç®—é¡Œ
                            const percentages = [10, 20, 25, 30, 40, 50, 60, 75, 80, 90];
                            const percentage = percentages[Math.floor(Math.random() * percentages.length)];
                            const total = (Math.floor(Math.random() * 20) + 10) * 10; // 100, 110, 120, ... 290
                            const part = total * percentage / 100;
                            
                            const scenarios = [
                                { item: 'å­¸ç”Ÿ', context: `ç­ä¸Šæœ‰${total}åå­¸ç”Ÿï¼Œå…¶ä¸­${percentage}%æ˜¯ç”·ç”Ÿã€‚` },
                                { item: 'è˜‹æœ', context: `ç±ƒå­è£¡æœ‰${total}å€‹è˜‹æœï¼Œå…¶ä¸­${percentage}%æ˜¯ç´…è˜‹æœã€‚` },
                                { item: 'å…ƒ', context: `å°æ˜æœ‰${total}å…ƒï¼Œä»–èŠ±äº†${percentage}%è²·æ–‡å…·ã€‚` },
                                { item: 'é¡Œç›®', context: `å°è¯åšäº†${total}é¡Œæ•¸å­¸é¡Œï¼Œå…¶ä¸­${percentage}%åšå°äº†ã€‚` }
                            ];
                            
                            const scenario = scenarios[Math.floor(Math.random() * scenarios.length)];
                            
                            if (Math.random() < 0.5) { // æ±‚éƒ¨åˆ†
                                story = scenario.context;
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>é‚£éº¼æœ‰å¤šå°‘${scenario.item}${scenario.item === 'å…ƒ' ? 'ç”¨æ–¼è²·æ–‡å…·' : ''}ï¼Ÿ</div>`;
                                answer = part;
                            } else { // çµ¦å®šéƒ¨åˆ†æ±‚ç™¾åˆ†æ¯”
                                story = `ç­ä¸Šæœ‰${total}åå­¸ç”Ÿï¼Œå…¶ä¸­${part}åæ˜¯ç”·ç”Ÿã€‚`;
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>ç”·ç”Ÿå å…¨ç­å­¸ç”Ÿçš„ç™¾åˆ†ä¹‹å¹¾ï¼Ÿ</div>`;
                                answer = percentage + '%';
                            }
                            break;
                            
                        case 'æ¯”ä¾‹å•é¡Œ':
                            // ç”Ÿæˆæ¯”ä¾‹è¨ˆç®—é¡Œ
                            const ratios = [
                                [1, 2], [1, 3], [1, 4], [2, 3], [2, 5], [3, 4], [3, 5], [3, 7], [4, 5]
                            ];
                            const ratio = ratios[Math.floor(Math.random() * ratios.length)];
                            
                            const multiplier = Math.floor(Math.random() * 5) + 2; // 2-6
                            const value1 = ratio[0] * multiplier;
                            const value2 = ratio[1] * multiplier;
                            const total_value = value1 + value2;
                            
                            if (Math.random() < 0.5) { // æ±‚å€¼
                                story = `å°æ˜å’Œå°è¯åˆ†ç³–æœï¼Œå°æ˜åˆ†åˆ°çš„ç³–æœèˆ‡å°è¯åˆ†åˆ°çš„ç³–æœæ¯”æ˜¯${ratio[0]}:${ratio[1]}ã€‚ä»–å€‘ä¸€å…±åˆ†åˆ°${total_value}å€‹ç³–æœã€‚`;
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>å°æ˜åˆ†åˆ°äº†å¤šå°‘å€‹ç³–æœï¼Ÿ</div>`;
                                answer = value1;
                            } else { // çµ¦å®šå€¼æ±‚æ¯”ä¾‹
                                story = `å°æ˜æœ‰${value1}å¼µè²¼ç´™ï¼Œå°è¯æœ‰${value2}å¼µè²¼ç´™ã€‚`;
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>å°æ˜çš„è²¼ç´™æ•¸èˆ‡å°è¯çš„è²¼ç´™æ•¸ä¹‹æ¯”æ˜¯å¤šå°‘ï¼Ÿ(ç”¨æœ€ç°¡åˆ†æ•¸è¡¨ç¤º)</div>`;
                                answer = `${ratio[0]}:${ratio[1]}`;
                            }
                            break;
                            
                        case 'é¢ç©è¨ˆç®—':
                            // ç”ŸæˆçŸ©å½¢æˆ–æ­£æ–¹å½¢é¢ç©è¨ˆç®—é¡Œ
                            if (Math.random() < 0.7) { // çŸ©å½¢
                                const length = Math.floor(Math.random() * 10) + 5; // 5-14
                                const width = Math.floor(Math.random() * 5) + 3;  // 3-7
                                const area = length * width;
                                
                                if (Math.random() < 0.5) { // æ±‚é¢ç©
                                    story = `ä¸€å€‹é•·æ–¹å½¢çš„é•·æ˜¯${length}å…¬å°ºï¼Œå¯¬æ˜¯${width}å…¬å°ºã€‚`;
                                    question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>é€™å€‹é•·æ–¹å½¢çš„é¢ç©æ˜¯å¤šå°‘å¹³æ–¹å…¬å°ºï¼Ÿ</div>`;
                                    answer = area;
                                } else { // çµ¦å®šé¢ç©å’Œä¸€é‚Šæ±‚å¦ä¸€é‚Š
                                    if (Math.random() < 0.5) {
                                        story = `ä¸€å€‹é•·æ–¹å½¢çš„é¢ç©æ˜¯${area}å¹³æ–¹å…¬å°ºï¼Œé•·æ˜¯${length}å…¬å°ºã€‚`;
                                        question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>é€™å€‹é•·æ–¹å½¢çš„å¯¬æ˜¯å¤šå°‘å…¬å°ºï¼Ÿ</div>`;
                                        answer = width;
                                    } else {
                                        story = `ä¸€å€‹é•·æ–¹å½¢çš„é¢ç©æ˜¯${area}å¹³æ–¹å…¬å°ºï¼Œå¯¬æ˜¯${width}å…¬å°ºã€‚`;
                                        question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>é€™å€‹é•·æ–¹å½¢çš„é•·æ˜¯å¤šå°‘å…¬å°ºï¼Ÿ</div>`;
                                        answer = length;
                                    }
                                }
                            } else { // æ­£æ–¹å½¢
                                const side = Math.floor(Math.random() * 15) + 5; // 5-19
                                const area = side * side;
                                
                                if (Math.random() < 0.5) { // æ±‚é¢ç©
                                    story = `ä¸€å€‹æ­£æ–¹å½¢çš„é‚Šé•·æ˜¯${side}å˜ç±³ã€‚`;
                                    question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>é€™å€‹æ­£æ–¹å½¢çš„é¢ç©æ˜¯å¤šå°‘å¹³æ–¹å˜ç±³ï¼Ÿ</div>`;
                                    answer = area;
                                } else { // çµ¦å®šé¢ç©æ±‚é‚Šé•·
                                    story = `ä¸€å€‹æ­£æ–¹å½¢çš„é¢ç©æ˜¯${area}å¹³æ–¹å˜ç±³ã€‚`;
                                    question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">${story}<br>é€™å€‹æ­£æ–¹å½¢çš„é‚Šé•·æ˜¯å¤šå°‘å˜ç±³ï¼Ÿ</div>`;
                                    answer = side;
                                }
                            }
                            break;
                            
                        case 'é‚è¼¯æ¨ç†':
                            // ç”Ÿæˆç°¡å–®é‚è¼¯æ¨ç†é¡Œ
                            const logicTypes = ['æ•¸åˆ—', 'è¦å¾‹æ‰¾æ•¸'];
                            const logicType = logicTypes[Math.floor(Math.random() * logicTypes.length)];
                            
                            if (logicType === 'æ•¸åˆ—') {
                                // ç”Ÿæˆç­‰å·®æ•¸åˆ—
                                const start = Math.floor(Math.random() * 10) + 1; // 1-10
                                const diff = Math.floor(Math.random() * 5) + 1;  // 1-5
                                
                                const sequence = [];
                                for (let i = 0; i < 5; i++) {
                                    sequence.push(start + diff * i);
                                }
                                
                                const nextNum = start + diff * 5;
                                
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">æ‰¾å‡ºæ•¸åˆ—çš„è¦å¾‹ï¼Œä¸¦å¡«å…¥ä¸‹ä¸€å€‹æ•¸ï¼š<br><span class="text-2xl">${sequence.join(', ')}ï¼Œ?</span></div>`;
                                answer = nextNum;
                            } else { // è¦å¾‹æ‰¾æ•¸
                                // ç”Ÿæˆä¹˜æ³•æˆ–å¹³æ–¹è¦å¾‹
                                const rules = [
                                    // å¹³æ–¹æ•¸
                                    () => {
                                        const sequence = [1, 4, 9, 16, 25, 36, 49, 64];
                                        const selected = Math.floor(Math.random() * (sequence.length - 4));
                                        return { sequence: sequence.slice(selected, selected + 4), next: sequence[selected + 4] };
                                    },
                                    // ä¹˜ä»¥å›ºå®šæ•¸
                                    () => {
                                        const multiplier = Math.floor(Math.random() * 3) + 2; // 2, 3, 4
                                        const start = Math.floor(Math.random() * 4) + 1; // 1-4
                                        
                                        const sequence = [];
                                        let current = start;
                                        for (let i = 0; i < 4; i++) {
                                            sequence.push(current);
                                            current *= multiplier;
                                        }
                                        
                                        return { sequence, next: current };
                                    },
                                    // æ–æ³¢é‚£å¥‘æ•¸åˆ—çš„ä¸€éƒ¨åˆ†
                                    () => {
                                        const fibonacci = [1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89];
                                        const selected = Math.floor(Math.random() * (fibonacci.length - 5));
                                        return { sequence: fibonacci.slice(selected, selected + 4), next: fibonacci[selected + 4] };
                                    }
                                ];
                                
                                const rule = rules[Math.floor(Math.random() * rules.length)]();
                                question = `<div class="word-problem bg-amber-50 dark:bg-gray-800 p-4 mb-2 rounded-lg">æ‰¾å‡ºæ•¸åˆ—çš„è¦å¾‹ï¼Œä¸¦å¡«å…¥ä¸‹ä¸€å€‹æ•¸ï¼š<br><span class="text-2xl">${rule.sequence.join(', ')}ï¼Œ?</span></div>`;
                                answer = rule.next;
                            }
                            break;
                    }
                    
                    return { question, answer };
                }
            }
        ];

        // ç”Ÿæˆé¡Œç›®
        function generateQuestion() {
            // éš±è—ä¹‹å‰çš„åé¥‹
            feedback.className = 'hidden';
            
            // å¦‚æœéŠæˆ²å·²çµæŸï¼Œä¸ç”Ÿæˆæ–°å•é¡Œ
            if (!isGameRunning) return;
            
            // éš¨æ©Ÿé¸æ“‡é¡Œå‹
            const questionTypeIndex = Math.floor(Math.random() * questionTypes.length);
            const questionType = questionTypes[questionTypeIndex];
            
            // ç”Ÿæˆå•é¡Œå’Œç­”æ¡ˆ
            const { question, answer } = questionType.generator();
            
            // ç”Ÿæˆé¸é …
            let options = [];
            const correctAnswer = answer;
            
            // ç‰¹æ®Šæƒ…æ³è™•ç†
            let answerIsText = false;
            let numAnswer;
            
            if (typeof correctAnswer === 'string') {
                // æª¢æŸ¥æ˜¯å¦ç‚ºç™¾åˆ†æ¯”å½¢å¼
                if (correctAnswer.includes('%')) {
                    const numValue = parseInt(correctAnswer);
                    numAnswer = numValue;
                    options = generateNumericOptions(numValue, 5, 10);
                    options = options.map(opt => opt + '%');
                }
                // æª¢æŸ¥æ˜¯å¦ç‚ºæ¯”ä¾‹å½¢å¼ (å¦‚ 1:2)
                else if (correctAnswer.includes(':')) {
                    answerIsText = true;
                    const ratios = [
                        '1:2', '1:3', '1:4', '2:3', '2:5', '3:4', '3:5', '3:7', '4:5',
                        '5:6', '5:8', '6:7', '7:8', '7:9', '8:9'
                    ];
                    options = [correctAnswer];
                    
                    // å¾å…¶ä»–æ¯”ä¾‹ä¸­é¸æ“‡ä¸‰å€‹ä¸åŒçš„é¸é …
                    while (options.length < 4) {
                        const newRatio = ratios[Math.floor(Math.random() * ratios.length)];
                        if (!options.includes(newRatio)) {
                            options.push(newRatio);
                        }
                    }
                }
                // æª¢æŸ¥æ˜¯å¦ç‚ºåˆ†æ•¸å½¢å¼ (å¦‚ 3/4)
                else if (correctAnswer.includes('/')) {
                    answerIsText = true;
                    const fractions = [
                        '1/2', '1/3', '1/4', '1/5', '2/3', '2/5', '3/4', '3/5', '3/8', '4/5',
                        '5/6', '5/8', '6/7', '7/8', '7/9', '8/9'
                    ];
                    options = [correctAnswer];
                    
                    // å¾å…¶ä»–åˆ†æ•¸ä¸­é¸æ“‡ä¸‰å€‹ä¸åŒçš„é¸é …
                    while (options.length < 4) {
                        const newFraction = fractions[Math.floor(Math.random() * fractions.length)];
                        if (!options.includes(newFraction)) {
                            options.push(newFraction);
                        }
                    }
                }
                // æ··åˆæ•¸æª¢æŸ¥ (å¦‚ "2åˆ1/3")
                else if (correctAnswer.includes('åˆ')) {
                    answerIsText = true;
                    // ç”Ÿæˆå¹¾å€‹å¯èƒ½çš„æ··åˆæ•¸
                    const mixedNumbers = [
                        '1åˆ1/2', '1åˆ1/3', '1åˆ2/3', '2åˆ1/4', '2åˆ1/3', '2åˆ2/3',
                        '2åˆ3/4', '3åˆ1/4', '3åˆ1/2', '3åˆ3/4'
                    ];
                    options = [correctAnswer];
                    
                    // å¾å…¶ä»–æ··åˆæ•¸ä¸­é¸æ“‡ä¸‰å€‹ä¸åŒçš„é¸é …
                    while (options.length < 4) {
                        const newMixed = mixedNumbers[Math.floor(Math.random() * mixedNumbers.length)];
                        if (!options.includes(newMixed)) {
                            options.push(newMixed);
                        }
                    }
                }
                else {
                    // å˜—è©¦å°‡å­—ä¸²è½‰æ›ç‚ºæ•¸å­—
                    numAnswer = parseFloat(correctAnswer);
                    if (!isNaN(numAnswer)) {
                        options = generateNumericOptions(numAnswer, 5, 10);
                    } else {
                        // å¦‚æœç„¡æ³•è½‰æ›ï¼Œå‰‡é€™æ˜¯ä¸€å€‹æ–‡æœ¬ç­”æ¡ˆ
                        answerIsText = true;
                        options = [correctAnswer, 'éŒ¯èª¤ç­”æ¡ˆ1', 'éŒ¯èª¤ç­”æ¡ˆ2', 'éŒ¯èª¤ç­”æ¡ˆ3'];
                    }
                }
            } else {
                // æ•¸å­—ç­”æ¡ˆ
                numAnswer = correctAnswer;
                options = generateNumericOptions(correctAnswer, 5, 10);
            }
            
            // å¦‚æœæ˜¯æ–‡æœ¬é¸é …ï¼Œéš¨æ©Ÿæ’åº
            if (answerIsText) {
                options = shuffleArray(options);
            }
            
            // æ›´æ–°UI
            questionText.innerHTML = question;
            answerA.textContent = options[0];
            answerB.textContent = options[1];
            answerC.textContent = options[2];
            answerD.textContent = options[3];
            
            // ç¢ºå®šæ­£ç¢ºé¸é …
            let correctOption;
            if (answerIsText) {
                const correctIndex = options.findIndex(opt => opt === correctAnswer);
                correctOption = String.fromCharCode(65 + correctIndex); // A, B, C, or D
            } else {
                // æ‰¾å‡ºå’Œæ­£ç¢ºç­”æ¡ˆæœ€æ¥è¿‘çš„é¸é …
                let minDiff = Infinity;
                let correctIndex = 0;
                
                for (let i = 0; i < options.length; i++) {
                    let optionValue = options[i];
                    // ç§»é™¤ç™¾åˆ†æ¯”ç¬¦è™Ÿé€²è¡Œæ¯”è¼ƒ
                    if (typeof optionValue === 'string' && optionValue.includes('%')) {
                        optionValue = parseInt(optionValue);
                    }
                    
                    const diff = Math.abs(optionValue - numAnswer);
                    if (diff < minDiff) {
                        minDiff = diff;
                        correctIndex = i;
                    }
                }
                
                correctOption = String.fromCharCode(65 + correctIndex); // A, B, C, or D
            }
            
            // å„²å­˜ç•¶å‰å•é¡Œè³‡è¨Š
            currentQuestion = {
                question,
                answer: correctAnswer,
                options,
                correctOption
            };

            // æ·»åŠ å‹•ç•«æ•ˆæœ
            questionText.classList.add('animate-float');
            setTimeout(() => {
                questionText.classList.remove('animate-float');
            }, 1000);
        }

        // ç”Ÿæˆæ•¸å­—é¸é …
        function generateNumericOptions(correctAnswer, maxVariation, minVariation = 1) {
            let options = [correctAnswer];
            
            // è™•ç†æ­£ç¢ºç­”æ¡ˆæ˜¯0çš„ç‰¹æ®Šæƒ…æ³
            if (correctAnswer === 0) {
                while (options.length < 4) {
                    const newOption = Math.floor(Math.random() * 5) + 1; // 1-5
                    if (!options.includes(newOption)) {
                        options.push(newOption);
                    }
                }
                return shuffleArray(options);
            }
            
            // è¨ˆç®—è®ŠåŒ–ç¯„åœ
            const variation = Math.max(Math.ceil(correctAnswer * 0.2), minVariation);
            const actualVariation = Math.min(variation, maxVariation);
            
            // ç”ŸæˆéŒ¯èª¤é¸é …
            while (options.length < 4) {
                // éš¨æ©Ÿæ±ºå®šåŠ æˆ–æ¸›ï¼Œä½†ç¢ºä¿çµæœç‚ºæ­£
                let offset;
                do {
                    offset = Math.floor(Math.random() * actualVariation * 2 + 1) - actualVariation;
                } while (offset === 0 || correctAnswer + offset <= 0);
                
                const newOption = correctAnswer + offset;
                
                // ç¢ºä¿æ²’æœ‰é‡è¤‡é¸é …
                if (!options.includes(newOption)) {
                    options.push(newOption);
                }
            }
            
            return shuffleArray(options);
        }

        // æ•¸çµ„æ´—ç‰Œ
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // è™•ç†ç­”æ¡ˆ
        function processAnswer(option) {
            if (!isGameRunning || !currentQuestion) return;
            
            const isCorrect = option === currentQuestion.correctOption;
            
            // ç²å–é¸ä¸­çš„é¸é …å…ƒç´ 
            const selectedOptionIndex = option.charCodeAt(0) - 65; // A=0, B=1, C=2, D=3
            const selectedOptionElement = document.querySelectorAll('.option-card')[selectedOptionIndex];
            
            // æ·»åŠ å°„æ“Šå‹•ç•«
            selectedOptionElement.classList.add('hit-animation');
            setTimeout(() => {
                selectedOptionElement.classList.remove('hit-animation');
            }, 500);
            
            // é¡¯ç¤ºåé¥‹
            feedbackText.textContent = isCorrect 
                ? 'âœ“ æ­£ä¸­ç›®æ¨™ï¼' 
                : `âœ— å°„åäº†ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯: ${currentQuestion.correctOption}`;
            
            feedback.className = isCorrect 
                ? 'block p-6 rounded-xl mb-6 text-center font-bold text-xl bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 flex items-center justify-center'
                : 'block p-6 rounded-xl mb-6 text-center font-bold text-xl bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 flex items-center justify-center';
            
            // æ·»åŠ åé¥‹åœ–æ¨™
            if (isCorrect) {
                feedbackText.innerHTML = `<i class="fas fa-bullseye mr-2"></i> æ­£ä¸­ç›®æ¨™ï¼`;
                
                // æ’­æ”¾æ…¶ç¥å‹•ç•«
                playCelebrationAnimation();
            } else {
                feedbackText.innerHTML = `<i class="fas fa-times-circle mr-2"></i> å°„åäº†ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯: ${currentQuestion.correctOption}`;
                
                // æ’­æ”¾æ‰“æ°£å‹•ç•«
                playEncouragementAnimation();
            }
                
            // æ›´æ–°åˆ†æ•¸ä¸¦æ·»åŠ å‹•ç•«
            if (isCorrect) {
                score++;
                scoreDisplay.textContent = score;
                scoreDisplay.classList.add('score-up');
                setTimeout(() => {
                    scoreDisplay.classList.remove('score-up');
                }, 700);
            }
            
            // å»¶é²å¾Œç”Ÿæˆæ–°å•é¡Œ
            setTimeout(() => {
                if (isGameRunning) {
                    generateQuestion();
                }
            }, 1500);
        }

        // æ·»åŠ éµç›¤æ”¯æŒï¼ˆç”¨æ–¼æ¸¬è©¦ï¼‰
        document.addEventListener('keydown', (e) => {
            if (!isGameRunning) return;
            
            const key = e.key.toUpperCase();
            if (key === 'A' || key === 'B' || key === 'C' || key === 'D') {
                processAnswer(key);
            }
        });
    </script>
</body>
</html>
